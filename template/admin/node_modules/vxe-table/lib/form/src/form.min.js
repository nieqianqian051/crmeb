"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_size=_interopRequireDefault(require("../../mixins/size")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_utils=require("../../tools/utils"),_dom=_interopRequireWildcard(require("../../tools/dom")),_util=require("./util"),_log=require("../../tools/log"),_formConfigItem=_interopRequireDefault(require("./form-config-item")),_index=_interopRequireDefault(require("../../loading/index")),_vn=require("../../tools/vn");function _getRequireWildcardCache(t){var e,i;return"function"!=typeof WeakMap?null:(e=new WeakMap,i=new WeakMap,(_getRequireWildcardCache=function(t){return t?i:e})(t))}function _interopRequireWildcard(t,e){if(!e&&t&&t.__esModule)return t;if(null===t||"object"!=_typeof(t)&&"function"!=typeof t)return{default:t};e=_getRequireWildcardCache(e);if(e&&e.has(t))return e.get(t);var i,r,n={__proto__:null},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(i in t)"default"!==i&&{}.hasOwnProperty.call(t,i)&&((r=o?Object.getOwnPropertyDescriptor(t,i):null)&&(r.get||r.set)?Object.defineProperty(n,i,r):n[i]=t[i]);return n.default=t,e&&e.set(t,n),n}function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _defineProperty(t,e,i){return(e=_toPropertyKey(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,_toPropertyKey(r.key),r)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function _toPropertyKey(t){t=_toPrimitive(t,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(t,e){if("object"!=_typeof(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0===i)return("string"===e?String:Number)(t);i=i.call(t,e||"default");if("object"!=_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}var Rule=function(){return _createClass(function t(e){_classCallCheck(this,t),Object.assign(this,{$options:e,required:e.required,min:e.min,max:e.min,type:e.type,pattern:e.pattern,validator:e.validator,trigger:e.trigger,maxWidth:e.maxWidth})},[{key:"content",get:function(){return(0,_utils.getFuncText)(this.$options.content||this.$options.message)}},{key:"message",get:function(){return this.content}}])}();function validErrorRuleValue(t,e){var i=t.type,r=t.min,n=t.max,t=t.pattern,i="number"===i,o=i?_xeUtils.default.toNumber(e):_xeUtils.default.getSize(e);return!(!i||!isNaN(e))||!_xeUtils.default.eqNull(r)&&o<_xeUtils.default.toNumber(r)||!_xeUtils.default.eqNull(n)&&o>_xeUtils.default.toNumber(n)||!(!t||(_xeUtils.default.isRegExp(t)?t:new RegExp(t)).test(e))}function getResetValue(t,e){return e=_xeUtils.default.isArray(t)?[]:e}var _default2=exports.default={name:"VxeForm",mixins:[_size.default],props:{collapseStatus:{type:Boolean,default:!0},loading:Boolean,data:Object,size:{type:String,default:function(){return _conf.default.form.size||_conf.default.size}},span:{type:[String,Number],default:function(){return _conf.default.form.span}},align:{type:String,default:function(){return _conf.default.form.align}},titleAlign:{type:String,default:function(){return _conf.default.form.titleAlign}},titleWidth:{type:[String,Number],default:function(){return _conf.default.form.titleWidth}},titleColon:{type:Boolean,default:function(){return _conf.default.form.titleColon}},titleAsterisk:{type:Boolean,default:function(){return _conf.default.form.titleAsterisk}},titleOverflow:{type:[Boolean,String],default:null},vertical:{type:Boolean,default:null},className:[String,Function],disabled:Boolean,readonly:Boolean,items:Array,rules:Object,preventSubmit:{type:Boolean,default:function(){return _conf.default.form.preventSubmit}},validConfig:Object,tooltipConfig:Object,customLayout:{type:Boolean,default:function(){return _conf.default.form.customLayout}}},inject:{$xegrid:{default:null}},data:function(){return{collapseAll:this.collapseStatus,staticItems:[],formItems:[],tooltipTimeout:null,tooltipStore:{item:null,visible:!1}}},provide:function(){return{$xeform:this,$xeformgather:null,$xeformitem:null,$xeformiteminfo:null}},computed:{xegrid:function(){return this.$xegrid},validOpts:function(){return Object.assign({},_conf.default.form.validConfig,this.validConfig)},tooltipOpts:function(){return Object.assign({},_conf.default.tooltip,_conf.default.form.tooltipConfig,this.tooltipConfig)}},watch:{staticItems:function(t){this.formItems=t},items:function(t){this.loadItem(t)},collapseStatus:function(t){this.collapseAll=!!t}},created:function(){var t=this.items;t&&t.length&&this.loadItem(t)},render:function(i){var t=this._e,e=this.loading,r=this.className,n=this.data,o=this.vSize,l=this.tooltipOpts,a=this.formItems,s=this.customLayout,u=_vXETable.default._tooltip,f=this.$scopedSlots.default,c=this.$scopedSlots.loading;return i("form",{class:["vxe-form",r?_xeUtils.default.isFunction(r)?r({items:a,data:n,$form:this}):r:"",_defineProperty(_defineProperty({},"size--".concat(o),o),"is--loading",e)],on:{submit:this.submitEvent,reset:this.resetEvent}},[i("div",{class:"vxe-form--wrapper vxe-form--item-row"},s?f?this.callSlot(f,{},i):[]:a.map(function(t,e){return i(_formConfigItem.default,{key:e,props:{itemConfig:t}})})),i("div",{class:"vxe-form-slots",ref:"hideItem"},!s&&f?this.callSlot(f,{},i):[]),i(_index.default,{class:"vxe-form--loading",props:{value:e}},c?this.callSlot(c,{},i):[]),u?i("vxe-tooltip",{ref:"tooltip",props:l}):t()])},methods:{dispatchEvent:function(t,e,i){this.$emit(t,Object.assign({$form:this,$grid:this.xegrid,$event:i},e))},callSlot:function(t,e,i){if(t){var r=this.$scopedSlots;if(_xeUtils.default.isString(t)&&(t=r[t]||null),_xeUtils.default.isFunction(t))return(0,_vn.getSlotVNs)(t.call(this,e,i))}return[]},loadItem:function(t){var e,i=this;return"development"===process.env.NODE_ENV&&(e=this.$scopedSlots,t.forEach(function(t){t.slots&&_xeUtils.default.each(t.slots,function(t){_xeUtils.default.isFunction(t)||e[t]||(0,_log.errLog)("vxe.error.notSlot",[t])})})),this.staticItems=_xeUtils.default.mapTree(t,function(t){return(0,_util.createItem)(i,t)},{children:"children"}),this.$nextTick()},getItems:function(){var e=[];return _xeUtils.default.eachTree(this.formItems,function(t){e.push(t)},{children:"children"}),e},getItemByField:function(e){var t=_xeUtils.default.findTree(this.formItems,function(t){return t.field===e},{children:"children"});return t?t.item:null},toggleCollapse:function(){var t=!this.collapseAll;return this.collapseAll=t,this.$emit("update:collapseStatus",t),this.$nextTick()},toggleCollapseEvent:function(t){this.toggleCollapse();var e=this.collapseAll;this.dispatchEvent("toggle-collapse",{status:e,collapse:e,data:this.data},t),this.dispatchEvent("collapse",{status:e,collapse:e,data:this.data},t)},submitEvent:function(e){var i=this,t=this.readonly;e.preventDefault(),this.preventSubmit||(this.clearValidate(),t?this.dispatchEvent("submit",{data:this.data},e):this.beginValidate(this.getItems()).then(function(t){t?i.dispatchEvent("submit-invalid",{data:i.data,errMap:t},e):i.dispatchEvent("submit",{data:i.data},e)}))},reset:function(){var o=this,l=this.data;return l&&this.getItems().forEach(function(t){var e,i=t.field,r=t.resetValue,n=t.itemRender;(0,_utils.isEnableConf)(n)&&(e=(n=_vXETable.default.renderer.get(n.name))?n.formItemResetMethod||n.itemResetMethod:null,n&&e?e({data:l,field:i,property:i,item:t,$form:o,$grid:o.xegrid}):i&&_xeUtils.default.set(l,i,null===r?getResetValue(_xeUtils.default.get(l,i),void 0):_xeUtils.default.clone(r,!0)))}),this.clearValidate()},resetEvent:function(t){t.preventDefault(),this.reset(),this.dispatchEvent("reset",{data:this.data},t)},closeTooltip:function(){var t=this.tooltipStore,e=this.$refs.tooltip;return t.visible&&(Object.assign(t,{item:null,visible:!1}),e)&&e.close(),this.$nextTick()},triggerTitleTipEvent:function(t,e){var e=e.item,i=this.tooltipStore,r=this.$refs.tooltip,t=t.currentTarget.children[0],n=(t.textContent||"").trim(),o=t.scrollWidth>t.clientWidth;clearTimeout(this.tooltipTimeout),i.item!==e&&this.closeTooltip(),n&&o&&(Object.assign(i,{item:e,visible:!0}),r)&&r.open(t,n)},handleTitleTipLeaveEvent:function(){var t=this,e=this.tooltipOpts,i=this.$refs.tooltip;i&&i.setActived(!1),e.enterable?this.tooltipTimeout=setTimeout(function(){(i=t.$refs.tooltip)&&!i.isActived()&&t.closeTooltip()},e.leaveDelay):this.closeTooltip()},clearValidate:function(t){var e,i=this;return t?(e=_xeUtils.default.isArray(e=t)?e:[t]).forEach(function(t){t&&(t=(0,_util.handleFieldOrItem)(i,t))&&(t.showError=!1)}):this.getItems().forEach(function(t){t.showError=!1}),this.$nextTick()},validate:function(t){var e=this.readonly;return this.clearValidate(),e?this.$nextTick():this.beginValidate(this.getItems(),"",t)},validateField:function(t,e){var i,r=this;return this.readonly?this.$nextTick():(i=[],i=_xeUtils.default.isArray(t)?t:[t],this.beginValidate(i.map(function(t){return(0,_util.handleFieldOrItem)(r,t)}),"",e))},beginValidate:function(e,t,i){var r=this,n=this.data,o=this.rules,l=this.validOpts,a={},s=[],u=[];return clearTimeout(this.showErrTime),n&&o?(e.forEach(function(e){var i=e.field;i&&!(0,_util.isHiddenItem)(r,e)&&(0,_util.isActivetem)(r,e)&&u.push(r.validItemRules(t||"all",i).then(function(){e.errRule=null}).catch(function(t){t=t[i];return a[i]||(a[i]=[]),a[i].push(t),s.push(i),e.errRule=t[0].rule,Promise.reject(t)}))}),Promise.all(u).then(function(){i&&i()}).catch(function(){return new Promise(function(t){r.showErrTime=setTimeout(function(){e.forEach(function(t){t.errRule&&(t.showError=!0)})},20),l.autoPos&&r.$nextTick(function(){r.handleFocus(s)}),i?(i(a),t()):t(a)})})):(i&&i(),Promise.resolve())},validItemRules:function(p,t,e){var m=this,h=this.data,i=this.rules,r={};return _xeUtils.default.isArray(t)||(t=[t]),Promise.all(t.map(function(s){var u,f,c=[],d=[];return s&&i&&(u=_xeUtils.default.get(i,s))&&(f=_xeUtils.default.isUndefined(e)?_xeUtils.default.get(h,s):e,u.forEach(function(e){var t,i,r,n=e.type,o=e.trigger,l=e.required,a=e.validator;"all"!==p&&o&&p!==e.trigger||(a?(r={itemValue:f,rule:e,rules:u,data:h,field:s,property:s,$form:m},_xeUtils.default.isString(a)?(i=_vXETable.default.validators.get(a))?i.itemValidatorMethod?t=i.itemValidatorMethod(r):"development"===process.env.NODE_ENV&&(0,_log.warnLog)("vxe.error.notValidators",[a]):"development"===process.env.NODE_ENV&&(0,_log.errLog)("vxe.error.notValidators",[a]):t=a(r),t&&(_xeUtils.default.isError(t)?d.push(new Rule({type:"custom",trigger:o,content:t.message,rule:new Rule(e)})):t.catch&&c.push(t.catch(function(t){d.push(new Rule({type:"custom",trigger:o,content:t?t.message:e.content||e.message,rule:new Rule(e)}))})))):(i="array"===n,a=_xeUtils.default.isArray(f),r=!0,r=i||a?!a||!f.length:_xeUtils.default.isString(f)?(0,_utils.eqEmptyValue)(f.trim()):(0,_utils.eqEmptyValue)(f),(l?r||validErrorRuleValue(e,f):!r&&validErrorRuleValue(e,f))&&d.push(new Rule(e))))})),Promise.all(c).then(function(){d.length&&(r[s]=d.map(function(t){return{$form:m,rule:t,data:h,field:s,property:s}}))})})).then(function(){if(!_xeUtils.default.isEmpty(r))return Promise.reject(r)})},handleFocus:function(t){for(var e=this.$el,i=0;i<t.length;i++){var r=t[i],r=this.getItemByField(r);if(r&&(0,_utils.isEnableConf)(r.itemRender)){var n=r.itemRender,o=_vXETable.default.renderer.get(n.name),l=void 0;if(i||_dom.default.scrollToView(e.querySelector(".".concat(r.id))),l=!(l=n.autofocus?e.querySelector(".".concat(r.id," ").concat(n.autofocus)):l)&&o&&o.autofocus?e.querySelector(".".concat(r.id," ").concat(o.autofocus)):l){l.focus(),_dom.browse.msie&&((n=l.createTextRange()).collapse(!1),n.select());break}}}},triggerItemEvent:function(t,i,e){var r=this;return i?this.validItemRules(t?["blur"].includes(t.type)?"blur":"change":"all",i,e).then(function(){r.clearValidate(i)}).catch(function(t){var t=t[i],e=r.getItemByField(i);e&&t&&(e.showError=!0,e.errRule=t[0].rule)}):this.$nextTick()},updateStatus:function(t,e){t=t.field;return this.triggerItemEvent(new Event("change"),t,e)}}};