"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_utils=_interopRequireWildcard(require("../../tools/utils")),_util=require("./util"),_dom=_interopRequireDefault(require("../../tools/dom")),_vn=require("../../tools/vn");function _getRequireWildcardCache(e){var t,l;return"function"!=typeof WeakMap?null:(t=new WeakMap,l=new WeakMap,(_getRequireWildcardCache=function(e){return e?l:t})(e))}function _interopRequireWildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=_typeof(e)&&"function"!=typeof e)return{default:e};t=_getRequireWildcardCache(t);if(t&&t.has(e))return t.get(e);var l,r,o={__proto__:null},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(l in e)"default"!==l&&{}.hasOwnProperty.call(e,l)&&((r=n?Object.getOwnPropertyDescriptor(e,l):null)&&(r.get||r.set)?Object.defineProperty(o,l,r):o[l]=e[l]);return o.default=e,t&&t.set(e,o),o}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function ownKeys(t,e){var l,r=Object.keys(t);return Object.getOwnPropertySymbols&&(l=Object.getOwnPropertySymbols(t),e&&(l=l.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,l)),r}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var l=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(l),!0).forEach(function(e){_defineProperty(t,e,l[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(l)):ownKeys(Object(l)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(l,e))})}return t}function _defineProperty(e,t,l){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:l,enumerable:!0,configurable:!0,writable:!0}):e[t]=l,e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==_typeof(e)?e:e+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var l=e[Symbol.toPrimitive];if(void 0===l)return("string"===t?String:Number)(e);l=l.call(e,t||"default");if("object"!=_typeof(l))return l;throw new TypeError("@@toPrimitive must return a primitive value.")}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){var l;if(e)return"string"==typeof e?_arrayLikeToArray(e,t):"Map"===(l="Object"===(l=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:l)||"Set"===l?Array.from(e):"Arguments"===l||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(l)?_arrayLikeToArray(e,t):void 0}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var l=0,r=new Array(t);l<t;l++)r[l]=e[l];return r}var scrollProcessTimeout,renderType="body";function isVMScrollProcess(e){return e._isResize||e.lastScrollTime&&Date.now()<e.lastScrollTime+e.delayHover}function renderLine(e,t,l,r){var o=r.row,n=r.column,i=l.afterFullData,a=l.treeOpts,s=l.treeConfig,c=l.fullAllDataRowIdData,d=n.slots,n=n.treeNode,c=c[(0,_util.getRowid)(l,o)],u=0,p=0,f=[];return c&&(u=c.level,p=c._index,f=c.items),d&&d.line?l.callSlot(d.line,r,e):(c=l.eqRow(i[0],o),s&&n&&(a.showLine||a.line)?[e("div",{class:"vxe-tree--line-wrapper"},[e("div",{class:"vxe-tree--line",style:{height:"".concat(c?1:(0,_util.calcTreeLine)(r,f,p),"px"),left:"".concat(u*a.indent+(u?2-(0,_util.getOffsetSize)(l):0)+16,"px")}})])]:[])}function renderColumn(e,D,t,l,r,o,n,i,a,s,M,c,d,A,u){var Y,p=t.$listeners,f=t.afterFullData,y=t.tableData,W=t.height,q=t.columnKey,h=t.overflowX,g=t.sYOpts,m=t.scrollXLoad,v=t.scrollYLoad,B=t.highlightCurrentRow,U=t.showOverflow,N=t.isAllOverflow,b=t.align,X=t.currentColumn,V=t.cellClassName,F=t.cellStyle,K=t.mergeList,z=t.spanMethod,G=t.radioOpts,J=t.checkboxOpts,Q=t.expandOpts,Z=t.treeOpts,w=t.tooltipOpts,ee=t.mouseConfig,x=t.editConfig,_=t.editOpts,S=t.editRules,T=t.validOpts,te=t.editStore,O=t.tooltipConfig,le=t.rowOpts,re=t.columnOpts,oe=t.validErrorMaps,ne=c.type,ie=c.cellRender,C=c.editRender,ae=c.align,P=c.showOverflow,se=c.className,ce=c.treeNode,de=c.slots,te=te.actived,g=g.rHeight,$=le.height,L=C||ie,L=L?_vXETable.default.renderer.get(L.name):null,ue=L?L.tableCellClassName||L.cellClassName:"",L=L?L.tableCellStyle||L.cellStyle:"",R=w.showAll||w.enabled,w=t.getColumnIndex(c),pe=t.getVTColumnIndex(c),fe=(0,_utils.isEnableConf)(C),h=o?c.fixed!==o:c.fixed&&h,P=_xeUtils.default.isUndefined(P)||_xeUtils.default.isNull(P)?U:P,k="ellipsis"===P,E="title"===P,I=!0===P||"tooltip"===P,P=E||I||k,H={},ae=ae||b,b=oe["".concat(r,":").concat(c.id)],oe=S&&T.showMessage&&("default"===T.message?W||1<y.length:"inline"===T.message),S={colid:c.id},ye=p["cell-mouseenter"],he=p["cell-mouseleave"],W=C&&x&&"dblclick"===_.trigger,j={$table:t,$grid:t.$xegrid,seq:l,rowid:r,row:i,rowIndex:a,$rowIndex:s,_rowIndex:M,column:c,columnIndex:w,$columnIndex:d,_columnIndex:pe,fixed:o,type:renderType,isHidden:h,level:n,visibleData:f,data:y,items:u};if(!m&&!v||P||(k=P=!0),(E||I||R||ye||O)&&(H.mouseenter=function(e){isVMScrollProcess(t)||(E?_dom.default.updateCellTitle(e.currentTarget,c):(I||R)&&t.triggerBodyTooltipEvent(e,j),ye&&t.emitEvent("cell-mouseenter",Object.assign({cell:e.currentTarget},j),e))}),(I||R||he||O)&&(H.mouseleave=function(e){isVMScrollProcess(t)||((I||R)&&t.handleTargetLeaveEvent(e),he&&t.emitEvent("cell-mouseleave",Object.assign({cell:e.currentTarget},j),e))}),(J.range||ee)&&(H.mousedown=function(e){t.triggerCellMousedownEvent(e,j)}),(le.isCurrent||B||p["cell-click"]||C&&x||"row"===Q.trigger||"cell"===Q.trigger||"row"===G.trigger||"radio"===c.type&&"cell"===G.trigger||"row"===J.trigger||"checkbox"===c.type&&"cell"===J.trigger||"row"===Z.trigger||c.treeNode&&"cell"===Z.trigger)&&(H.click=function(e){t.triggerCellClickEvent(e,j)}),(W||p["cell-dblclick"])&&(H.dblclick=function(e){t.triggerCellDblclickEvent(e,j)}),K.length){l=(0,_util.mergeBodyMethod)(K,M,pe);if(l){r=l.rowspan,a=l.colspan;if(!r||!a)return null;1<r&&(S.rowspan=r),1<a&&(S.colspan=a)}}else if(z){s=z(j)||{},w=s.rowspan,o=void 0===w?1:w,n=s.colspan,f=void 0===n?1:n;if(!o||!f)return null;1<o&&(S.rowspan=o),1<f&&(S.colspan=f)}!(h=h&&K&&(1<S.colspan||1<S.rowspan)?!1:h)&&x&&(C||ie)&&(_.showStatus||_.showUpdateStatus)&&(Y=t.isUpdateByRow(i,c.field));y=[];return h&&U&&N?y.push(e("div",{class:["vxe-cell",{"c--title":E,"c--tooltip":I,"c--ellipsis":k}],style:{maxHeight:P&&(g||$)?"".concat(g||$,"px"):""}})):(y.push.apply(y,_toConsumableArray(renderLine(e,D,t,j)).concat([e("div",{class:["vxe-cell",{"c--title":E,"c--tooltip":I,"c--ellipsis":k}],style:{maxHeight:P&&(g||$)?"".concat(g||$,"px"):""},attrs:{title:E?t.getCellLabel(i,c):null}},c.renderCell(e,j))])),oe&&b&&(u=b.rule,m=de?de.valid:null,v=_objectSpread(_objectSpread({},j),b),y.push(e("div",{class:["vxe-cell--valid-error-hint",_utils.default.getClass(T.className,b)],style:u&&u.maxWidth?{width:"".concat(u.maxWidth,"px")}:null},m?t.callSlot(m,v,e):[e("span",{class:"vxe-cell--valid-error-msg"},b.content)])))),e("td",{class:["vxe-body--column",c.id,(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(O={},"col--".concat(ae),ae),"col--".concat(ne),ne),"col--last",d===A.length-1),"col--tree-node",ce),"col--edit",fe),"col--ellipsis",P),"fixed--hidden",h),"col--dirty",Y),"col--active",x&&fe&&te.row===i&&(te.column===c||"row"===_.mode)),"col--valid-error",!!b),_defineProperty(O,"col--current",X===c)),_utils.default.getClass(ue,j),_utils.default.getClass(se,j),_utils.default.getClass(V,j)],key:q||re.useKey?c.id:d,attrs:S,style:Object.assign({height:P&&(g||$)?"".concat(g||$,"px"):""},_xeUtils.default.isFunction(L)?L(j):L,_xeUtils.default.isFunction(F)?F(j):F),on:H},y)}function renderRows(h,g,m,v,b,w){var x=m.stripe,_=m.rowKey,S=m.highlightHoverRow,T=m.rowClassName,O=m.rowStyle,C=m.editConfig,P=m.showOverflow,$=m.treeConfig,L=m.treeOpts,R=m.expandOpts,k=m.editOpts,E=m.treeExpandedMaps,I=m.scrollYLoad,H=m.rowExpandedMaps,j=m.radioOpts,D=m.checkboxOpts,M=m.expandColumn,A=m.hasFixedColumn,Y=m.fullAllDataRowIdData,W=m.rowOpts,q=m.pendingRowList,B=m.pendingRowMaps,U=L.children||L.childrenField,N=[];return b.forEach(function(l,r){var e,t,o={},n=m.getVTRowIndex(l),i=m.getRowIndex(l),a=((W.isHover||S)&&(o.mouseenter=function(e){isVMScrollProcess(m)||m.triggerHoverEvent(e,{row:l,rowIndex:i})},o.mouseleave=function(){isVMScrollProcess(m)||m.clearHoverRow()}),(0,_util.getRowid)(m,l)),s=Y[a],c=s?s.level:0,d=s?s.seq:-1,s={$table:m,seq:d,rowid:a,fixed:v,type:renderType,level:c,row:l,rowIndex:i,$rowIndex:r},u=M&&!!H[a],p=!1,f=[],y=!1;C&&(y=m.isInsertByRow(l)),!$||I||L.transform||(p=(f=l[U])&&f.length&&!!E[a]),N.push(h("tr",{class:["vxe-body--row",$?"row--level-".concat(c):"",{"row--stripe":x&&(m.getVTRowIndex(l)+1)%2==0,"is--new":y,"is--expand-row":u,"is--expand-tree":p,"row--new":y&&(k.showStatus||k.showInsertStatus),"row--radio":j.highlight&&m.selectRadioRow===l,"row--checked":D.highlight&&m.isCheckedByCheckboxRow(l),"row--pending":q.length&&!!B[a]},T?_xeUtils.default.isFunction(T)?T(s):T:""],attrs:{rowid:a},style:O?_xeUtils.default.isFunction(O)?O(s):O:null,key:_||W.useKey||$?a:r,on:o},w.map(function(e,t){return renderColumn(h,g,m,d,a,v,c,l,i,r,n,e,t,w,b)}))),u&&(y=R.height,s=R.padding,u={},y&&(u.height="".concat(y,"px")),$&&(u.paddingLeft="".concat(c*L.indent+30,"px")),e=M.showOverflow,e=_xeUtils.default.isUndefined(e)||_xeUtils.default.isNull(e)?P:e,t={$table:m,seq:d,column:M,fixed:v,type:renderType,level:c,row:l,rowIndex:i,$rowIndex:r},N.push(h("tr",{class:["vxe-body--expanded-row",{"is--padding":s}],key:"expand_".concat(a),style:O?_xeUtils.default.isFunction(O)?O(t):O:null,on:o},[h("td",{class:{"vxe-body--expanded-column":1,"fixed--hidden":v&&!A,"col--ellipsis":e},attrs:{colspan:w.length}},[h("div",{class:{"vxe-body--expanded-cell":1,"is--ellipsis":y},style:u},[M.renderData(h,t)])])]))),p&&N.push.apply(N,_toConsumableArray(renderRows(h,g,m,v,f,w)))}),N}function syncBodyScroll(e,t,l,r,o){(r||o)&&(r&&((0,_util.removeScrollListener)(r),r.scrollTop=l),o&&((0,_util.removeScrollListener)(o),o.scrollTop=l),clearTimeout(scrollProcessTimeout),scrollProcessTimeout=setTimeout(function(){(0,_util.restoreScrollListener)(r),(0,_util.restoreScrollListener)(o)},300))}var _default=exports.default={name:"VxeTableBody",props:{tableData:Array,tableColumn:Array,fixedColumn:Array,size:String,fixedType:String},data:function(){return{wheelTime:null,wheelYSize:0,wheelYInterval:0,wheelYTotal:0}},mounted:function(){var e=this.$parent,t=this.$el,l=this.$refs,r=this.fixedType,e=e.elemStore,r="".concat(r||"main","-body-");e["".concat(r,"wrapper")]=t,e["".concat(r,"table")]=l.table,e["".concat(r,"colgroup")]=l.colgroup,e["".concat(r,"list")]=l.tbody,e["".concat(r,"xSpace")]=l.xSpace,e["".concat(r,"ySpace")]=l.ySpace,e["".concat(r,"emptyBlock")]=l.emptyBlock,this.$el&&(this.$el.onscroll=this.scrollEvent,this.$el._onscroll=this.scrollEvent)},beforeDestroy:function(){clearTimeout(this.wheelTime),this.$el&&(this.$el._onscroll=null,this.$el.onscroll=null)},destroyed:function(){var e=this.$parent,t=this.fixedType,e=e.elemStore,t="".concat(t||"main","-body-");e["".concat(t,"wrapper")]=null,e["".concat(t,"table")]=null,e["".concat(t,"colgroup")]=null,e["".concat(t,"list")]=null,e["".concat(t,"xSpace")]=null,e["".concat(t,"ySpace")]=null,e["".concat(t,"emptyBlock")]=null},render:function(l){var e=this._e,t=this.$parent,r=this.fixedColumn,o=this.fixedType,n=t.$scopedSlots,i=t.tId,a=t.tableData,s=t.tableColumn,c=t.visibleColumn,d=t.expandColumn,u=t.showOverflow,p=t.keyboardConfig,f=t.keyboardOpts,y=t.mergeList,h=t.spanMethod,g=t.scrollXLoad,m=t.scrollYLoad,v=t.isAllOverflow,b=t.emptyOpts,w=t.mouseConfig,x=t.mouseOpts,_=t.sYOpts;return o&&(s=d||!(g||m||u&&v)||y.length||h||p&&f.isMerge?c:r),u=n.empty?n.empty.call(this,{$table:t},l):(g=(d=b.name?_vXETable.default.renderer.get(b.name):null)?d.renderTableEmptyView||d.renderEmpty:null)?(0,_vn.getSlotVNs)(g.call(this,l,b,{$table:t})):t.emptyText||_conf.default.i18n("vxe.table.emptyText"),l("div",{class:["vxe-table--body-wrapper",o?"fixed-".concat(o,"--wrapper"):"body--wrapper"],attrs:{xid:i},on:m&&"wheel"===_.mode?{wheel:this.wheelEvent}:{}},[o?e():l("div",{class:"vxe-body--x-space",ref:"xSpace"}),l("div",{class:"vxe-body--y-space",ref:"ySpace"}),l("table",{class:"vxe-table--body",attrs:{xid:i,cellspacing:0,cellpadding:0,border:0},ref:"table"},[l("colgroup",{ref:"colgroup"},s.map(function(e,t){return l("col",{attrs:{name:e.id},key:t})})),l("tbody",{ref:"tbody"},renderRows(l,this,t,o,a,s))]),l("div",{class:"vxe-table--checkbox-range"}),w&&x.area?l("div",{class:"vxe-table--cell-area"},[l("span",{class:"vxe-table--cell-main-area"},x.extension?[l("span",{class:"vxe-table--cell-main-area-btn",on:{mousedown:function(e){t.triggerCellExtendMousedownEvent(e,{$table:t,fixed:o,type:renderType})}}})]:null),l("span",{class:"vxe-table--cell-copy-area"}),l("span",{class:"vxe-table--cell-extend-area"}),l("span",{class:"vxe-table--cell-multi-area"}),l("span",{class:"vxe-table--cell-active-area"})]):null,o?null:l("div",{class:"vxe-table--empty-block",ref:"emptyBlock"},[l("div",{class:"vxe-table--empty-content"},u)])])},methods:{scrollEvent:function(e){var t=this.$el,l=this.$parent,r=this.fixedType,o=l.$refs,n=l.elemStore,i=l.highlightHoverRow,a=l.scrollXLoad,s=l.scrollYLoad,c=l.lastScrollTop,d=l.lastScrollLeft,u=l.rowOpts,p=o.tableHeader,f=o.tableBody,y=o.leftBody,h=o.rightBody,g=o.tableFooter,o=o.validTip,p=p?p.$el:null,g=g?g.$el:null,f=f.$el,y=y?y.$el:null,h=h?h.$el:null,m=n["main-body-ySpace"],n=n["main-body-xSpace"],m=(s&&m?m:f).clientHeight,n=(a&&n?n:f).clientWidth,t=t.scrollTop,v=f.scrollLeft,d=v!==d,c=t!==c;l.lastScrollTop=t,l.lastScrollLeft=v,l.lastScrollTime=Date.now(),(u.isHover||i)&&l.clearHoverRow(),y&&"left"===r?syncBodyScroll(l,r,t=y.scrollTop,f,h):h&&"right"===r?syncBodyScroll(l,r,t=h.scrollTop,f,y):(d&&(p&&(p.scrollLeft=f.scrollLeft),g)&&(g.scrollLeft=f.scrollLeft),(y||h)&&(l.checkScrolling(),c)&&syncBodyScroll(l,r,t,y,h)),a&&d&&l.triggerScrollXEvent(e),s&&c&&l.triggerScrollYEvent(e),d&&o&&o.visible&&o.updatePlacement(),l.emitEvent("scroll",{type:renderType,fixed:r,scrollTop:t,scrollLeft:v,scrollHeight:f.scrollHeight,scrollWidth:f.scrollWidth,bodyHeight:m,bodyWidth:n,isX:d,isY:c},e)},handleWheel:function(a,s,e,c,d){var u=this,p=this.$parent,t=p.$refs,l=p.elemStore,r=p.scrollYLoad,o=p.scrollXLoad,n=t.tableBody,i=t.leftBody,t=t.rightBody,f=n.$el,y=i?i.$el:null,h=t?t.$el:null,n=this.isPrevWheelTop===s?Math.max(0,this.wheelYSize-this.wheelYTotal):0,i=l["main-body-ySpace"],t=l["main-body-xSpace"],g=(r&&i?i:f).clientHeight,m=(o&&t?t:f).clientWidth;this.isPrevWheelTop=s,this.wheelYSize=Math.abs(s?e-n:e+n),this.wheelYInterval=0,this.wheelYTotal=0,clearTimeout(this.wheelTime),function e(){var t,l,r=u.fixedType,o=u.wheelYTotal,n=u.wheelYSize,i=u.wheelYInterval;o<n&&(n<(o+=i=Math.max(5,Math.floor(1.5*i)))&&(i-=o-n),n=f.scrollTop,t=f.clientHeight,l=f.scrollHeight,f.scrollTop=n=n+i*(s?-1:1),y&&(y.scrollTop=n),h&&(h.scrollTop=n),(s?n<l-t:0<=n)&&(u.wheelTime=setTimeout(e,10)),u.wheelYTotal=o,u.wheelYInterval=i,p.emitEvent("scroll",{type:renderType,fixed:r,scrollTop:f.scrollTop,scrollLeft:f.scrollLeft,scrollHeight:f.scrollHeight,scrollWidth:f.scrollWidth,bodyHeight:g,bodyWidth:m,isX:c,isY:d},a))}()},wheelEvent:function(e){var t=e.deltaY,l=e.deltaX,r=this.$el,o=this.$parent,n=o.$refs,i=o.highlightHoverRow,a=o.scrollYLoad,s=o.lastScrollTop,c=o.lastScrollLeft,d=o.rowOpts,n=n.tableBody.$el,u=t<0;(u?r.scrollTop<=0:r.scrollTop>=r.scrollHeight-r.clientHeight)||(r=r.scrollTop+t,l=(n=n.scrollLeft+l)!==c,(c=r!==s)&&(e.preventDefault(),o.lastScrollTop=r,o.lastScrollLeft=n,o.lastScrollTime=Date.now(),(d.isHover||i)&&o.clearHoverRow(),this.handleWheel(e,u,t,l,c),a)&&o.triggerScrollYEvent(e))}}};