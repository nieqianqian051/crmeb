"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.calcTreeLine=calcTreeLine,exports.clearTableAllStatus=clearTableAllStatus,exports.clearTableDefaultStatus=clearTableDefaultStatus,exports.colToVisible=colToVisible,exports.convertHeaderColumnToRows=void 0,exports.getColReMinWidth=getColReMinWidth,exports.getColumnConfig=getColumnConfig,exports.getOffsetSize=getOffsetSize,exports.getRootColumn=getRootColumn,exports.getRowid=getRowid,exports.getRowkey=getRowkey,exports.handleFieldOrColumn=handleFieldOrColumn,exports.isColumnInfo=isColumnInfo,exports.mergeBodyMethod=mergeBodyMethod,exports.removeScrollListener=removeScrollListener,exports.restoreScrollListener=restoreScrollListener,exports.restoreScrollLocation=restoreScrollLocation,exports.rowToVisible=rowToVisible,exports.toFilters=toFilters,exports.toTreePathSeq=toTreePathSeq;var _vXETable=_interopRequireDefault(require("../../v-x-e-table")),_xeUtils=_interopRequireDefault(require("xe-utils")),_columnInfo=require("./columnInfo"),_dom=_interopRequireDefault(require("../../tools/dom"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,r){var t;if(e)return"string"==typeof e?_arrayLikeToArray(e,r):"Map"===(t="Object"===(t=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:t)||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,r):void 0}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,l=new Array(r);t<r;t++)l[t]=e[t];return l}var getAllConvertColumns=function r(e,t){var l=[];return e.forEach(function(e){e.parentId=t?t.id:null,e.visible&&(e.children&&e.children.length&&e.children.some(function(e){return e.visible})?(l.push(e),l.push.apply(l,_toConsumableArray(r(e.children,e)))):l.push(e))}),l},convertHeaderColumnToRows=exports.convertHeaderColumnToRows=function(e){for(var o=1,r=function r(t,e){var l;e&&(t.level=e.level+1,o<t.level)&&(o=t.level),t.children&&t.children.length&&t.children.some(function(e){return e.visible})?(l=0,t.children.forEach(function(e){e.visible&&(r(e,t),l+=e.colSpan)}),t.colSpan=l):t.colSpan=1},t=(e.forEach(function(e){e.level=1,r(e)}),[]),l=0;l<o;l++)t.push([]);return getAllConvertColumns(e).forEach(function(e){e.children&&e.children.length&&e.children.some(function(e){return e.visible})?e.rowSpan=1:e.rowSpan=o-e.level+1,t[e.level-1].push(e)}),t},lineOffsetSizes={mini:3,small:2,medium:1};function restoreScrollLocation(e,r,t){return e.clearScroll().then(function(){if(r||t)return e.lastScrollLeft=0,e.lastScrollTop=0,e.scrollTo(r,t)})}function toTreePathSeq(e){return e.map(function(e,r){return r%2==0?Number(e)+1:"."}).join("")}function removeScrollListener(e){e&&e._onscroll&&(e.onscroll=null)}function restoreScrollListener(e){e&&e._onscroll&&(e.onscroll=e._onscroll)}function getRowkey(e){return e.rowOpts.keyField||e.rowId||"_X_ROW_KEY"}function getRowid(e,r){r=_xeUtils.default.get(r,getRowkey(e));return _xeUtils.default.eqNull(r)?"":encodeURIComponent(r)}function getPaddingLeftRightSize(e){return e?(e=getComputedStyle(e),_xeUtils.default.toNumber(e.paddingLeft)+_xeUtils.default.toNumber(e.paddingRight)):0}function getElemenMarginWidth(e){var r,t;return e?(t=getComputedStyle(e),r=_xeUtils.default.toNumber(t.marginLeft),t=_xeUtils.default.toNumber(t.marginRight),e.offsetWidth+r+t):0}function handleFieldOrColumn(e,r){return r?_xeUtils.default.isString(r)?e.getColumnByField(r):r:null}function getRootColumn(e,r){var t=e.fullColumnIdData;if(!r)return null;for(var l=r.parentId;t[l];){var o=t[l].column;if(!(l=o.parentId))return o}return r}function queryCellElement(e,r){return e.querySelector(".vxe-cell"+r)}function toFilters(e){return e&&_xeUtils.default.isArray(e)?e.map(function(e){var r=e.label,t=e.value,l=e.data,o=e.resetValue,e=e.checked;return{label:r,value:t,data:l,resetValue:o,checked:!!e,_checked:!!e}}):e}function getColReMinWidth(e){var r=e.$table,t=e.column,l=e.cell,o=r.showHeaderOverflow,n=r.resizableOpts.minWidth;if(n){e=_xeUtils.default.isFunction(n)?n(e):n;if("auto"!==e)return Math.max(1,_xeUtils.default.toNumber(e))}var i,a,u,n=t.showHeaderOverflow,e=t.minWidth,t=_xeUtils.default.isUndefined(n)||_xeUtils.default.isNull(n)?o:n,o="title"===t||(!0===t||"tooltip"===t)||"ellipsis"===t,n=_xeUtils.default.floor(1.6*(_xeUtils.default.toNumber(getComputedStyle(l).fontSize)||14))+(getPaddingLeftRightSize(l)+getPaddingLeftRightSize(queryCellElement(l,"")));if(o&&(t=getPaddingLeftRightSize(queryCellElement(l,"--title>.vxe-cell--checkbox")),o=getElemenMarginWidth(queryCellElement(l,">.vxe-cell--required-icon")),c=getElemenMarginWidth(queryCellElement(l,">.vxe-cell--edit-icon")),i=getElemenMarginWidth(queryCellElement(l,">.vxe-cell-title-prefix-icon")),a=getElemenMarginWidth(queryCellElement(l,">.vxe-cell-title-suffix-icon")),u=getElemenMarginWidth(queryCellElement(l,">.vxe-cell--sort")),n+=t+o+c+i+a+getElemenMarginWidth(queryCellElement(l,">.vxe-cell--filter"))+u),e){var c,t=r.$refs.tableBody,o=t?t.$el:null;if(o){if(_dom.default.isScale(e))return c=(o.clientWidth-1)/100,Math.max(n,Math.floor(_xeUtils.default.toInteger(e)*c));if(_dom.default.isPx(e))return Math.max(n,_xeUtils.default.toInteger(e))}}return n}function countTreeExpand(e,r){var t=1;if(e){var l=r.$table,o=l.treeOpts,n=e[o.children||o.childrenField];if(n&&l.isTreeExpandByRow(e))for(var i=0;i<n.length;i++)t+=countTreeExpand(n[i],r)}return t}function getOffsetSize(e){return lineOffsetSizes[e.vSize]||0}function calcTreeLine(e,r,t){var l=e.$table,o=1;return t&&(o=countTreeExpand(r[t-1],e)),l.rowHeight*o-(t?1:12-getOffsetSize(l))}function mergeBodyMethod(e,r,t){for(var l=0;l<e.length;l++){var o=e[l],n=o.row,i=o.col,a=o.rowspan,o=o.colspan;if(-1<i&&-1<n&&a&&o){if(n===r&&i===t)return{rowspan:a,colspan:o};if(n<=r&&r<n+a&&i<=t&&t<i+o)return{rowspan:0,colspan:0}}}}function clearTableDefaultStatus(e){return e.initStatus=!1,e.clearSort(),e.clearCurrentRow(),e.clearCurrentColumn(),e.clearRadioRow(),e.clearRadioReserve(),e.clearCheckboxRow(),e.clearCheckboxReserve(),e.clearRowExpand(),e.clearTreeExpand(),e.clearTreeExpandReserve(),e.clearEdit&&_vXETable.default._edit&&e.clearEdit(),e.clearSelected&&(e.keyboardConfig||e.mouseConfig)&&e.clearSelected(),e.clearCellAreas&&e.mouseConfig&&(e.clearCellAreas(),e.clearCopyCellArea()),e.clearScroll()}function clearTableAllStatus(e){return e.clearFilter&&_vXETable.default._filter&&e.clearFilter(),clearTableDefaultStatus(e)}function isColumnInfo(e){return e instanceof _columnInfo.ColumnInfo}function getColumnConfig(e,r,t){return isColumnInfo(r)?r:new _columnInfo.ColumnInfo(e,r,t)}function rowToVisible(e,r){var t=e.$refs.tableBody,t=t?t.$el:null;if(t){var l=t.querySelector('[rowid="'.concat(getRowid(e,r),'"]'));if(l){var o=t.clientHeight,t=t.scrollTop,n=l.offsetTop+(l.offsetParent?l.offsetParent.offsetTop:0),l=l.clientHeight;if(n<t||t+o<n)return e.scrollTo(null,n);if(o+t<=n+l)return e.scrollTo(null,t+l)}else if(e.scrollYLoad)return e.scrollTo(null,(e.afterFullData.indexOf(r)-1)*e.scrollYStore.rowHeight)}return Promise.resolve()}function colToVisible(e,r){var t=e.$refs.tableBody,t=t?t.$el:null;if(t){var l=t.querySelector(".".concat(r.id));if(l){var o=t.clientWidth,t=t.scrollLeft,n=l.offsetLeft+(l.offsetParent?l.offsetParent.offsetLeft:0),l=l.clientWidth;if(n<t||t+o<n)return e.scrollTo(n);if(o+t<=n+l)return e.scrollTo(t+l)}else if(e.scrollXLoad){for(var i=e.visibleColumn,a=0,u=0;u<i.length&&i[u]!==r;u++)a+=i[u].renderWidth;return e.scrollTo(a)}}return Promise.resolve()}