"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_utils=_interopRequireWildcard(require("../../tools/utils")),_util=require("../../table/src/util"),_dom=_interopRequireWildcard(require("../../tools/dom")),_log=require("../../tools/log");function _getRequireWildcardCache(e){var t,r;return"function"!=typeof WeakMap?null:(t=new WeakMap,r=new WeakMap,(_getRequireWildcardCache=function(e){return e?r:t})(e))}function _interopRequireWildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=_typeof(e)&&"function"!=typeof e)return{default:e};t=_getRequireWildcardCache(t);if(t&&t.has(e))return t.get(e);var r,n,o={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(r in e)"default"!==r&&{}.hasOwnProperty.call(e,r)&&((n=i?Object.getOwnPropertyDescriptor(e,r):null)&&(n.get||n.set)?Object.defineProperty(o,r,n):o[r]=e[r]);return o.default=e,t&&t.set(e,o),o}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ownKeys(t,e){var r,n=Object.keys(t);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(t),e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,r)),n}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(r),!0).forEach(function(e){_defineProperty(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){var r;if(e)return"string"==typeof e?_arrayLikeToArray(e,t):"Map"===(r="Object"===(r=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function _defineProperty(e,t,r){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==_typeof(e)?e:e+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);r=r.call(e,t||"default");if("object"!=_typeof(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}function insertTreeRow(a,e,t){var s=a.tableFullTreeData,u=a.afterFullData,c=a.fullDataRowIdData,d=a.fullAllDataRowIdData,r=a.treeOpts,f=r.rowField,h=r.parentField,p=r.mapChildrenField,_=r.children||r.childrenField,m=t?"push":"unshift";e.forEach(function(e){var t,r,n,o=e[h],i=(0,_util.getRowid)(a,e),l=o?_xeUtils.default.findTree(s,function(e){return o===e[f]},{children:p}):null;l?(l=l.item,t=(t=d[(0,_util.getRowid)(a,l)])?t.level:0,n=l[_],r=l[p],_xeUtils.default.isArray(n)||(n=l[_]=[]),_xeUtils.default.isArray(r)||(r=l[_]=[]),n[m](e),r[m](e),c[i]=r={row:e,rowid:i,seq:-1,index:-1,_index:-1,$index:-1,items:n,parent:l,level:t+1},d[i]=r):("development"===process.env.NODE_ENV&&o&&(0,_log.warnLog)("vxe.error.unableInsert"),u[m](e),s[m](e),n={row:e,rowid:i,seq:-1,index:-1,_index:-1,$index:-1,items:s,parent:null,level:0},c[i]=n,d[i]=n)})}function handleInsertRowAt(n,e,t,o){var r=n.tableFullTreeData,i=n.mergeList,l=n.afterFullData,a=n.editStore,s=n.tableFullData,u=n.treeConfig,c=n.fullDataRowIdData,d=n.fullAllDataRowIdData,f=n.treeOpts,h=f.transform,p=f.rowField,_=f.mapChildrenField,m=f.children||f.childrenField,w=(_xeUtils.default.isArray(e)||(e=[e]),n.defineField(e.map(function(e){return Object.assign(u&&h?_defineProperty(_defineProperty({},_,[]),m,[]):{},e)})));if(_xeUtils.default.eqNull(t))u&&h?insertTreeRow(n,w,!1):(l.unshift.apply(l,_toConsumableArray(w)),s.unshift.apply(s,_toConsumableArray(w)),i.forEach(function(e){var t=e.row;0<t&&(e.row=t+w.length)}));else if(-1===t)u&&h?insertTreeRow(n,w,!0):(l.push.apply(l,_toConsumableArray(w)),s.push.apply(s,_toConsumableArray(w)),i.forEach(function(e){var t=e.row,r=e.rowspan;t+r>l.length&&(e.rowspan=r+w.length)}));else if(u&&h){var v,g,y,b=_xeUtils.default.findTree(r,function(e){return t[p]===e[p]},{children:_});b?(v=b.parent,g=v?v[_]:r,e=d[(0,_util.getRowid)(n,v)],y=e?e.level:0,w.forEach(function(e,t){var r=(0,_util.getRowid)(n,e),t=("development"===process.env.NODE_ENV&&e[f.parentField]&&v&&e[f.parentField]!==v[p]&&(0,_log.errLog)("vxe.error.errProp",["".concat(f.parentField,"=").concat(e[f.parentField]),"".concat(f.parentField,"=").concat(v[p])]),v&&(e[f.parentField]=v[p]),b.index+t),t=(o&&(t+=1),g.splice(t,0,e),{row:e,rowid:r,seq:-1,index:-1,_index:-1,$index:-1,items:g,parent:v,level:y+1});c[r]=t,d[r]=t}),v&&(e=_xeUtils.default.findTree(r,function(e){return t[p]===e[p]},{children:m}))&&(r=e.items,e=e.index,o&&(e+=1),r.splice.apply(r,[e,0].concat(_toConsumableArray(w))))):("development"===process.env.NODE_ENV&&(0,_log.warnLog)("vxe.error.unableInsert"),insertTreeRow(n,w,!0))}else{if(u)throw new Error((0,_log.getLog)("vxe.error.noTree",["insert"]));var x=-1;if(_xeUtils.default.isNumber(t)?t<l.length&&(x=t):x=n.findRowIndexOf(l,t),-1===(x=o?Math.min(l.length,x+1):x))throw new Error((0,_log.errLog)("vxe.error.unableInsert"));l.splice.apply(l,[x,0].concat(_toConsumableArray(w))),s.splice.apply(s,[n.findRowIndexOf(s,t),0].concat(_toConsumableArray(w))),i.forEach(function(e){var t=e.row,r=e.rowspan;x<t?e.row=t+w.length:x<t+r&&(e.rowspan=r+w.length)})}var r=a.insertList,C=a.insertMaps;return w.forEach(function(e){var t=(0,_util.getRowid)(n,e);C[t]=e}),r.unshift.apply(r,_toConsumableArray(w)),n.cacheRowMap(),n.updateScrollYStatus(),n.handleTableData(u&&h),u&&h||n.updateAfterDataIndex(),n.updateFooter(),n.checkSelectionStatus(),n.scrollYLoad&&n.updateScrollYSpace(),n.$nextTick().then(function(){return n.updateCellAreas(),n.recalculate()}).then(function(){return{row:w.length?w[w.length-1]:null,rows:w}})}var _default=exports.default={methods:{_insert:function(e){return handleInsertRowAt(this,e,null)},_insertAt:function(e,t){return handleInsertRowAt(this,e,t)},_insertNextAt:function(e,t){return handleInsertRowAt(this,e,t,!0)},_remove:function(e){var t,o=this,i=this.afterFullData,r=this.tableFullData,n=this.tableFullTreeData,l=this.treeConfig,a=this.mergeList,s=this.editStore,u=this.checkboxOpts,c=this.selectCheckboxMaps,d=this.isInsertByRow,f=this.treeOpts,h=f.transform,p=f.mapChildrenField,_=f.children||f.childrenField,f=s.actived,m=s.removeList,w=s.insertList,v=s.insertMaps,s=u.checkField,g=[];return e?_xeUtils.default.isArray(e)||(e=[e]):e=r,e.forEach(function(e){d(e)||m.push(e)}),s||(t=_objectSpread({},c),e.forEach(function(e){e=(0,_util.getRowid)(o,e);t[e]&&delete t[e]}),this.selectCheckboxMaps=t),r===e?(e=g=r.slice(0),this.tableFullData=[],this.afterFullData=[],this.clearMergeCells()):l&&h?e.forEach(function(e){var t=(0,_util.getRowid)(o,e),r=_xeUtils.default.findTree(n,function(e){return t===(0,_util.getRowid)(o,e)},{children:p}),r=(r&&(r=r.items.splice(r.index,1),g.push(r[0])),_xeUtils.default.findTree(n,function(e){return t===(0,_util.getRowid)(o,e)},{children:_})),r=(r&&r.items.splice(r.index,1),o.findRowIndexOf(i,e));-1<r&&i.splice(r,1)}):e.forEach(function(e){var t=o.findRowIndexOf(r,e),n=(-1<t&&(t=r.splice(t,1),g.push(t[0])),o.findRowIndexOf(i,e));-1<n&&(a.forEach(function(e){var t=e.row,r=e.rowspan;n<t?e.row=t-1:n<t+r&&(e.rowspan=r-1)}),i.splice(n,1))}),f.row&&-1<this.findRowIndexOf(e,f.row)&&this.clearEdit(),e.forEach(function(e){var t=(0,_util.getRowid)(o,e),e=o.findRowIndexOf(w,e);-1<e&&w.splice(e,1),delete v[t]}),this.handleTableData(l&&h),l&&h||this.updateAfterDataIndex(),this.updateFooter(),this.cacheRowMap(),this.checkSelectionStatus(),this.scrollYLoad&&this.updateScrollYSpace(),this.$nextTick().then(function(){return o.updateCellAreas(),o.recalculate()}).then(function(){return{row:g.length?g[g.length-1]:null,rows:g}})},_removeCheckboxRow:function(){var t=this;return this.remove(this.getCheckboxRecords()).then(function(e){return t.clearCheckboxRow(),e})},_removeRadioRow:function(){var t=this,e=this.getRadioRecord();return this.remove(e||[]).then(function(e){return t.clearRadioRow(),e})},_removeCurrentRow:function(){var t=this,e=this.getCurrentRecord();return this.remove(e||[]).then(function(e){return t.clearCurrentRow(),e})},_getRecordset:function(){return{insertRecords:this.getInsertRecords(),removeRecords:this.getRemoveRecords(),updateRecords:this.getUpdateRecords(),pendingRecords:this.getPendingRecords()}},_getInsertRecords:function(){var r=this,n=this.fullAllDataRowIdData,e=this.editStore.insertList,o=[];return e.forEach(function(e){var t=(0,_util.getRowid)(r,e);n[t]&&o.push(e)}),o},_getRemoveRecords:function(){return this.editStore.removeList},_getUpdateRecords:function(){var e=this.keepSource,t=this.tableFullData,r=this.isUpdateByRow,n=this.treeConfig,o=this.treeOpts,i=this.editStore;return e?(i=(e=i.actived).row,e=e.column,(i||e)&&this._syncActivedCell(),n?_xeUtils.default.filterTree(t,function(e){return r(e)},o):t.filter(function(e){return r(e)})):[]},handleActived:function(e,t){var r,n=this,o=this.editStore,i=this.editOpts,l=this.tableColumn,a=this.editConfig,s=this.mouseConfig,u=i.mode,c=o.actived,o=o.focused,d=e.row,f=e.column,h=f.editRender,p=e.cell=e.cell||this.getCellElement(d,f),_=i.beforeEditMethod||i.activeMethod;return p&&(0,_utils.isEnableConf)(a)&&(0,_utils.isEnableConf)(h)&&(this.hasPendingByRow(d)||(c.row!==d||"cell"===u&&c.column!==f?(a="edit-disabled",_&&!_(_objectSpread(_objectSpread({},e),{},{$table:this,$grid:this.$xegrid}))||(s&&(this.clearSelected(t),this.clearCellAreas(t),this.clearCopyCellArea(t)),this.closeTooltip(),c.column&&this.clearEdit(t),a="edit-activated",f.renderHeight=p.offsetHeight,c.args=e,c.row=d,c.column=f,"row"===u?l.forEach(function(e){return n._getColumnModel(d,e)}):this._getColumnModel(d,f),r=i.afterEditMethod,this.$nextTick(function(){n.handleFocus(e,t),r&&r(_objectSpread(_objectSpread({},e),{},{$table:n,$grid:n.$xegrid}))})),this.emitEvent(a,{row:d,rowIndex:this.getRowIndex(d),$rowIndex:this.getVMRowIndex(d),column:f,columnIndex:this.getColumnIndex(f),$columnIndex:this.getVMColumnIndex(f)},t),"edit-activated"===a&&this.emitEvent("edit-actived",{row:d,rowIndex:this.getRowIndex(d),$rowIndex:this.getVMRowIndex(d),column:f,columnIndex:this.getColumnIndex(f),$columnIndex:this.getVMColumnIndex(f)},t)):(h=c.column,s&&(this.clearSelected(t),this.clearCellAreas(t),this.clearCopyCellArea(t)),h!==f&&((_=h.model).update&&_utils.default.setCellValue(d,h,_.value),this.clearValidate()),f.renderHeight=p.offsetHeight,c.args=e,c.column=f,setTimeout(function(){n.handleFocus(e,t)})),o.column=null,o.row=null,this.focus())),this.$nextTick()},_getColumnModel:function(e,t){var r=t.model;t.editRender&&(r.value=_utils.default.getCellValue(e,t),r.update=!1)},_setColumnModel:function(e,t){var r=t.model;t.editRender&&r.update&&(_utils.default.setCellValue(e,t,r.value),r.update=!1,r.value=null)},_syncActivedCell:function(){var t=this,e=this.tableColumn,r=this.editStore,n=this.editOpts,r=r.actived,o=r.row,r=r.column;(o||r)&&("row"===n.mode?e.forEach(function(e){return t._setColumnModel(o,e)}):this._setColumnModel(o,r))},_clearActived:function(e){return"development"===process.env.NODE_ENV&&(0,_log.warnLog)("vxe.error.delFunc",["clearActived","clearEdit"]),this.clearEdit(e)},_clearEdit:function(e){var t=this.editStore,r=t.actived,t=t.focused,n=r.row,o=r.column;return(n||o)&&(this._syncActivedCell(),r.args=null,r.row=null,r.column=null,this.updateFooter(),this.emitEvent("edit-closed",{row:n,rowIndex:this.getRowIndex(n),$rowIndex:this.getVMRowIndex(n),column:o,columnIndex:this.getColumnIndex(o),$columnIndex:this.getVMColumnIndex(o)},e)),t.row=null,t.column=null,"obsolete"===_conf.default.cellVaildMode&&this.clearValidate?this.clearValidate():this.$nextTick()},_getActiveRecord:function(){return"development"===process.env.NODE_ENV&&(0,_log.warnLog)("vxe.error.delFunc",["getActiveRecord","getEditRecord"]),this.getEditRecord()},_getEditRecord:function(){var e=this.$el,t=this.editStore,r=this.afterFullData,t=t.actived,n=t.args,t=t.row;return n&&-1<this.findRowIndexOf(r,t)&&e.querySelectorAll(".vxe-body--column.col--active").length?Object.assign({},n):null},_isActiveByRow:function(e){return"development"===process.env.NODE_ENV&&(0,_log.warnLog)("vxe.error.delFunc",["isActiveByRow","isEditByRow"]),this.isEditByRow(e)},_isEditByRow:function(e){return this.editStore.actived.row===e},handleFocus:function(e){var t,r,n,o=e.row,i=e.column,l=e.cell,a=i.editRender;(0,_utils.isEnableConf)(a)&&(n=_vXETable.default.renderer.get(a.name),t=a.autofocus,a=a.autoselect,!t&&n&&(t=n.tableAutofocus||n.autofocus),!a&&n&&(a=n.tableAutoSelect||n.autoselect),_xeUtils.default.isFunction(t)?r=t.call(this,e):t&&(r=l.querySelector(t))&&r.focus(),r?a?r.select():_dom.browse.msie&&((n=r.createTextRange()).collapse(!1),n.select()):this.scrollToRow(o,i))},_setActiveRow:function(e){return"development"===process.env.NODE_ENV&&(0,_log.warnLog)("vxe.error.delFunc",["setActiveRow","setEditRow"]),this.setEditRow(e)},_setEditRow:function(e,t){var r=_xeUtils.default.find(this.visibleColumn,function(e){return(0,_utils.isEnableConf)(e.editRender)});return t&&(r=_xeUtils.default.isString(t)?this.getColumnByField(t):t),this.setEditCell(e,r)},_setActiveCell:function(e,t){return"development"===process.env.NODE_ENV&&(0,_log.warnLog)("vxe.error.delFunc",["setActiveCell","setEditCell"]),this.setEditCell(e,t)},_setEditCell:function(t,e){var r=this,n=this.editConfig,o=_xeUtils.default.isString(e)?this.getColumnByField(e):e;return t&&o&&(0,_utils.isEnableConf)(n)&&(0,_utils.isEnableConf)(o.editRender)?this.scrollToRow(t,!0).then(function(){var e=r.getCellElement(t,o);e&&(r.handleActived({row:t,rowIndex:r.getRowIndex(t),column:o,columnIndex:r.getColumnIndex(o),cell:e,$table:r}),r.lastCallTime=Date.now())}):this.$nextTick()},_setSelectCell:function(e,t){var r=this.tableData,n=this.editOpts,o=this.visibleColumn,t=_xeUtils.default.isString(t)?this.getColumnByField(t):t;return e&&t&&"manual"!==n.trigger&&-1<(n=this.findRowIndexOf(r,e))&&(r=this.getCellElement(e,t),e={row:e,rowIndex:n,column:t,columnIndex:o.indexOf(t),cell:r},this.handleSelected(e,{})),this.$nextTick()},handleSelected:function(e,t){var r=this,n=this.mouseConfig,o=this.mouseOpts,i=this.editOpts,l=this.editStore,a=l.actived,l=l.selected,s=e.row,u=e.column,n=n&&o.selected;return!n||l.row===s&&l.column===u||(a.row!==s||"cell"===i.mode&&a.column!==u)&&(r.clearEdit(t),r.clearSelected(t),r.clearCellAreas(t),r.clearCopyCellArea(t),l.args=e,l.row=s,l.column=u,n&&r.addColSdCls(),r.focus(),t)&&r.emitEvent("cell-selected",e,t),r.$nextTick()},_getSelectedCell:function(){var e=this.editStore.selected,t=e.args,e=e.column;return t&&e?Object.assign({},t):null},_clearSelected:function(){var e=this.editStore.selected;return e.row=null,e.column=null,this.reColTitleSdCls(),this.reColSdCls(),this.$nextTick()},reColTitleSdCls:function(){var e=this.elemStore["main-header-list"];e&&_xeUtils.default.arrayEach(e.querySelectorAll(".col--title-selected"),function(e){return _dom.default.removeClass(e,"col--title-selected")})},reColSdCls:function(){var e=this.$el.querySelector(".col--selected");e&&_dom.default.removeClass(e,"col--selected")},addColSdCls:function(){var e=this.editStore.selected,t=e.row,e=e.column;this.reColSdCls(),t&&e&&(t=this.getCellElement(t,e))&&_dom.default.addClass(t,"col--selected")}}};