"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_util=require("../../table/src/util"),_utils=require("../../tools/utils"),_log=require("../../tools/log"),_dom=_interopRequireDefault(require("../../tools/dom"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,r){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,_toPropertyKey(i.key),i)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==_typeof(e)?e:e+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);r=r.call(e,t||"default");if("object"!=_typeof(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}var Rule=function(){return _createClass(function e(t){_classCallCheck(this,e),Object.assign(this,{$options:t,required:t.required,min:t.min,max:t.max,type:t.type,pattern:t.pattern,validator:t.validator,trigger:t.trigger,maxWidth:t.maxWidth})},[{key:"content",get:function(){return(0,_utils.getFuncText)(this.$options.content||this.$options.message)}},{key:"message",get:function(){return this.content}}])}();function validErrorRuleValue(e,t){var r=e.type,i=e.min,l=e.max,e=e.pattern,r="number"===r,n=r?_xeUtils.default.toNumber(t):_xeUtils.default.getSize(t);return!(!r||!isNaN(t))||!_xeUtils.default.eqNull(i)&&n<_xeUtils.default.toNumber(i)||!_xeUtils.default.eqNull(l)&&n>_xeUtils.default.toNumber(l)||!(!e||(_xeUtils.default.isRegExp(e)?e:new RegExp(e)).test(t))}var _default=exports.default={methods:{_fullValidate:function(e,t){return"development"===process.env.NODE_ENV&&_xeUtils.default.isFunction(t)&&(0,_log.warnLog)("vxe.error.notValidators",["fullValidate(rows, callback)","fullValidate(rows)"]),this.beginValidate(e,t,!0)},_validate:function(e,t){return"development"===process.env.NODE_ENV&&_xeUtils.default.isFunction(t)&&(0,_log.warnLog)("vxe.error.notValidators",["validate(rows, callback)","validate(rows)"]),this.beginValidate(e,t)},handleValidError:function(t){var r=this,i=this.validOpts;return new Promise(function(e){!1===i.autoPos?(r.emitEvent("valid-error",t),e()):r.handleActived(t,{type:"valid-error",trigger:"call"}).then(function(){setTimeout(function(){e(r.showValidTooltip(t))},10)})})},handleErrMsgMode:function(e){var t,r;return"single"===this.validOpts.msgMode?(t=e,(r=Object.keys(e)).length&&(t[r=r[0]]=e[r]),t):e},beginValidate:function(e,s,l){var t,r,u=this,c={},n=this.editRules,d=this.afterFullData,f=this.visibleColumn,i=this.treeConfig,o=this.treeOpts,o=o.children||o.childrenField,a=(!0===e?t=d:e&&(_xeUtils.default.isFunction(e)?s=e:t=_xeUtils.default.isArray(e)?e:[e]),t=t||this.getInsertRecords().concat(this.getUpdateRecords()),[]),h=(this.lastCallTime=Date.now(),this.validRuleErr=!1,this.clearValidate(),{});return n?(r=this.getColumns(),e=function(i){var e;!l&&u.validRuleErr||(e=[],r.forEach(function(r){!l&&u.validRuleErr||!_xeUtils.default.has(n,r.property)||e.push(u.validCellRules("all",i,r).catch(function(e){var t=e.rule,e={rule:t,rules:e.rules,rowIndex:u.getRowIndex(i),row:i,columnIndex:u.getColumnIndex(r),column:r,field:r.property,$table:u};if(c[r.property]||(c[r.property]=[]),h["".concat((0,_util.getRowid)(u,i),":").concat(r.id)]={column:r,row:i,rule:t,content:t.content},c[r.property].push(e),!l)return u.validRuleErr=!0,Promise.reject(e)}))}),a.push(Promise.all(e)))},i?_xeUtils.default.eachTree(t,e,{children:o}):t.forEach(e),Promise.all(a).then(function(){var e=Object.keys(c);return u.validErrorMaps=u.handleErrMsgMode(h),u.$nextTick().then(function(){if(e.length)return Promise.reject(c[e[0]][0]);s&&s()})}).catch(function(a){return new Promise(function(e,t){function r(){u.$nextTick(function(){s?(s(c),e()):("obsolete"===_conf.default.validToReject?t:e)(c)})}var i,l,n,o;!1===u.validOpts.autoPos?r():(o=a.row,i=a.column,n=d.indexOf(o),l=f.indexOf(i),n=0<n?d[n-1]:o,o=0<l?f[l-1]:i,u.scrollToRow(n,o).then(function(){a.cell=u.getCellElement(a.row,a.column),_dom.default.scrollToView(a.cell),u.handleValidError(a).then(r)}))})})):(this.validErrorMaps={},this.$nextTick().then(function(){s&&s()}))},hasCellRules:function(t,e,r){var i=this.editRules,r=r.property;return!(!r||!i)&&(i=_xeUtils.default.get(i,r))&&_xeUtils.default.find(i,function(e){return"all"===t||!e.trigger||t===e.trigger})},validCellRules:function(s,u,c,e){var d,f,h=this,t=this.editRules,r=c.property,p=[],g=[];return r&&t&&(d=_xeUtils.default.get(t,r))&&(f=_xeUtils.default.isUndefined(e)?_xeUtils.default.get(u,r):e,d.forEach(function(t){var e,r,i,l=t.type,n=t.trigger,o=t.required,a=t.validator;"all"!==s&&n&&s!==n||(a?(i={cellValue:f,rule:t,rules:d,row:u,rowIndex:h.getRowIndex(u),column:c,columnIndex:h.getColumnIndex(c),field:c.property,$table:h},_xeUtils.default.isString(a)?(r=_vXETable.default.validators.get(a))?r.cellValidatorMethod?e=r.cellValidatorMethod(i):"development"===process.env.NODE_ENV&&(0,_log.warnLog)("vxe.error.notValidators",[a]):"development"===process.env.NODE_ENV&&(0,_log.errLog)("vxe.error.notValidators",[a]):e=a(i),e&&(_xeUtils.default.isError(e)?(h.validRuleErr=!0,p.push(new Rule({type:"custom",trigger:n,content:e.message,rule:new Rule(t)}))):e.catch&&g.push(e.catch(function(e){h.validRuleErr=!0,p.push(new Rule({type:"custom",trigger:n,content:e&&e.message?e.message:t.content||t.message,rule:new Rule(t)}))})))):(r="array"===l,a=_xeUtils.default.isArray(f),i=!0,i=r||a?!a||!f.length:_xeUtils.default.isString(f)?(0,_utils.eqEmptyValue)(f.trim()):(0,_utils.eqEmptyValue)(f),(o?i||validErrorRuleValue(t,f):!i&&validErrorRuleValue(t,f))&&(h.validRuleErr=!0,p.push(new Rule(t)))))})),Promise.all(g).then(function(){if(p.length)return Promise.reject({rules:p,rule:p[0]})})},_clearValidate:function(e,t){var r,i,l=this,n=this.validOpts,o=this.validErrorMaps,a=this.$refs.validTip,e=_xeUtils.default.isArray(e)?e:e?[e]:[],s=_xeUtils.default.isArray(t)?t:(t?[t]:[]).map(function(e){return(0,_util.handleFieldOrColumn)(l,e)}),u={};return a&&a.visible&&a.close(),"single"===n.msgMode?this.validErrorMaps={}:(e.length&&s.length?(u=Object.assign({},o),e.forEach(function(t){s.forEach(function(e){e="".concat((0,_util.getRowid)(l,t),":").concat(e.id);u[e]&&delete u[e]})})):e.length?(r=e.map(function(e){return"".concat((0,_util.getRowid)(l,e))}),_xeUtils.default.each(o,function(e,t){-1<r.indexOf(t.split(":")[0])&&(u[t]=e)})):s.length&&(i=s.map(function(e){return"".concat(e.id)}),_xeUtils.default.each(o,function(e,t){-1<i.indexOf(t.split(":")[1])&&(u[t]=e)})),this.validErrorMaps=u),this.$nextTick()},triggerValidate:function(t){var r=this,e=this.editConfig,i=this.editStore,l=this.editRules,n=this.editOpts,o=this.validOpts,i=i.actived;if(l&&"single"===o.msgMode&&(this.validErrorMaps={}),e&&l&&i.row){var o=i.args,a=o.row,s=o.column,u=o.cell;if(this.hasCellRules(t,a,s))return this.validCellRules(t,a,s).then(function(){"row"===n.mode&&r.clearValidate(a,s)}).catch(function(e){var e=e.rule;return e.trigger&&t!==e.trigger?Promise.resolve():(r.showValidTooltip(e={rule:e,row:a,column:s,cell:u}),Promise.reject(e))})}return Promise.resolve()},showValidTooltip:function(e){var t=this.$refs,r=this.height,i=this.validStore,l=this.validErrorMaps,n=this.tableData,o=this.validOpts,a=e.rule,s=e.row,u=e.column,c=e.cell,t=t.validTip,d=a.content;return i.visible=!0,"single"===o.msgMode?this.validErrorMaps=_defineProperty({},"".concat((0,_util.getRowid)(this,s),":").concat(u.id),{column:u,row:s,rule:a,content:d}):this.validErrorMaps=Object.assign({},l,_defineProperty({},"".concat((0,_util.getRowid)(this,s),":").concat(u.id),{column:u,row:s,rule:a,content:d})),this.emitEvent("valid-error",e,null),t&&("tooltip"===o.message||"default"===o.message&&!r&&n.length<2)?t.open(c,d):this.$nextTick()}}};