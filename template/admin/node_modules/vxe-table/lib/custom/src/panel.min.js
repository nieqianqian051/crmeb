"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vXETable=_interopRequireDefault(require("../../v-x-e-table")),_utils=_interopRequireDefault(require("../../tools/utils")),_dom=_interopRequireDefault(require("../../tools/dom")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_xeUtils=_interopRequireDefault(require("xe-utils"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var formatText=_utils.default.formatText,addClass=_dom.default.addClass,removeClass=_dom.default.removeClass;function updateDropHint(e,t){var o,e=e.$refs,l=e.dragHintElemRef,e=e.bodyElemRef;e&&l&&(o=(e=e.parentNode).getBoundingClientRect(),l.style.display="block",l.style.top="".concat(Math.min(e.clientHeight-e.scrollTop-l.clientHeight,t.clientY-o.y),"px"),l.style.left="".concat(Math.min(e.clientWidth-e.scrollLeft-l.clientWidth-16,t.clientX-o.x),"px"))}var renderSimplePanel=function(u,d){var m=d._e,e=d.$xetable,t=d.customStore,o=e.customColumnList,l=e.customOpts,f=e.isMaxFixedColumn,e=t.maxHeight,v=l.checkMethod,p=l.visibleMethod,x=l.allowVisible,b=l.allowSort,h=l.allowFixed,i=l.trigger,n=l.placement,g=[],s={},i=("hover"===i&&(s.mouseenter=d.handleWrapperMouseenterEvent,s.mouseleave=d.handleWrapperMouseleaveEvent),_xeUtils.default.eachTree(o,function(e,t,o,l,i){var n,s,a,c,r;p&&!p({column:e})||(n=e.renderVisible,s=e.halfVisible,a=e.children&&e.children.length,c=formatText(e.getTitle(),1),r=!!v&&!v({column:e}),g.push(u("li",{key:e.id,attrs:{colid:e.id},class:["vxe-table-custom--option","level--".concat(e.level),{"is--group":a}],on:{dragstart:d.sortDragstartEvent,dragend:d.sortDragendEvent,dragover:d.sortDragoverEvent}},[x?u("div",{class:["vxe-table-custom--checkbox-option",{"is--checked":n,"is--indeterminate":s,"is--disabled":r}],attrs:{title:_conf.default.i18n("vxe.custom.setting.colVisible")},on:{click:function(){r||d.changeCheckboxOption(e)}}},[u("span",{class:["vxe-checkbox--icon",s?_conf.default.icon.TABLE_CHECKBOX_INDETERMINATE:n?_conf.default.icon.TABLE_CHECKBOX_CHECKED:_conf.default.icon.TABLE_CHECKBOX_UNCHECKED]})]):m(),b&&1===e.level?u("div",{class:"vxe-table-custom--sort-option"},[u("span",{class:"vxe-table-custom--sort-btn",attrs:{title:_conf.default.i18n("vxe.custom.setting.sortHelpTip")},on:{mousedown:d.sortMousedownEvent,mouseup:d.sortMouseupEvent}},[u("i",{class:_conf.default.icon.TABLE_CUSTOM_SORT})])]):m(),u("div",{class:"vxe-table-custom--checkbox-label",attrs:{title:c}},c),!i&&h?u("div",{class:"vxe-table-custom--fixed-option"},[u("span",{class:["vxe-table-custom--fixed-left-option","left"===e.renderFixed?_conf.default.icon.TOOLBAR_TOOLS_FIXED_LEFT_ACTIVE:_conf.default.icon.TOOLBAR_TOOLS_FIXED_LEFT,{"is--checked":"left"===e.renderFixed,"is--disabled":f&&!e.renderFixed}],attrs:{title:_conf.default.i18n("left"===e.renderFixed?"vxe.toolbar.cancelFixed":"vxe.toolbar.fixedLeft")},on:{click:function(){d.changeFixedOption(e,"left")}}}),u("span",{class:["vxe-table-custom--fixed-right-option","right"===e.renderFixed?_conf.default.icon.TOOLBAR_TOOLS_FIXED_RIGHT_ACTIVE:_conf.default.icon.TOOLBAR_TOOLS_FIXED_RIGHT,{"is--checked":"right"===e.renderFixed,"is--disabled":f&&!e.renderFixed}],attrs:{title:_conf.default.i18n("right"===e.renderFixed?"vxe.toolbar.cancelFixed":"vxe.toolbar.fixedRight")},on:{click:function(){d.changeFixedOption(e,"right")}}})]):m()])))}),t.isAll),o=t.isIndeterminate;return u("div",{key:"simple",class:["vxe-table-custom-wrapper","placement--".concat(n),{"is--active":t.visible}],style:e&&!["left","right"].includes(n)?{maxHeight:"".concat(e,"px")}:{}},t.visible?[u("ul",{class:"vxe-table-custom--header"},[u("li",{class:"vxe-table-custom--option"},[x?u("div",{class:["vxe-table-custom--checkbox-option",{"is--checked":i,"is--indeterminate":o}],attrs:{title:_conf.default.i18n("vxe.table.allTitle")},on:{click:d.allCustomEvent}},[u("span",{class:["vxe-checkbox--icon",o?_conf.default.icon.TABLE_CHECKBOX_INDETERMINATE:i?_conf.default.icon.TABLE_CHECKBOX_CHECKED:_conf.default.icon.TABLE_CHECKBOX_UNCHECKED]}),u("span",{class:"vxe-checkbox--label"},_conf.default.i18n("vxe.toolbar.customAll"))]):u("span",{class:"vxe-checkbox--label"},_conf.default.i18n("vxe.table.customTitle"))])]),u("div",{ref:"bodyElemRef",class:"vxe-table-custom--list-wrapper"},[u("transition-group",{class:"vxe-table-custom--body",props:{name:"vxe-table-custom--list",tag:"ul"},on:s},g),u("div",{ref:"dragHintElemRef",class:"vxe-table-custom-popup--drag-hint"},_conf.default.i18n("vxe.custom.cstmDragTarget",[d.dragColumn?d.dragColumn.getTitle():""]))]),l.showFooter?u("div",{class:"vxe-table-custom--footer"},[u("button",{class:"btn--reset",on:{click:d.resetCustomEvent}},l.resetButtonText||_conf.default.i18n("vxe.table.customRestore")),l.immediate?m():u("button",{class:"btn--cancel",on:{click:d.cancelCustomEvent}},l.resetButtonText||_conf.default.i18n("vxe.table.customCancel")),u("button",{class:"btn--confirm",on:{click:d.confirmCustomEvent}},l.confirmButtonText||_conf.default.i18n("vxe.table.customConfirm"))]):null]:[])},renderPopupPanel=function(u,d){var m=d._e,e=d.$xetable,t=d.customStore,o=e.customOpts,l=e.customColumnList,i=e.columnOpts,f=e.isMaxFixedColumn,e=o.modalOptions,v=o.allowVisible,p=o.allowSort,x=o.allowFixed,b=o.allowResizable,h=o.checkMethod,g=o.visibleMethod,n=i.maxFixedSize,i=Object.assign({},e),C=[],s=(_xeUtils.default.eachTree(l,function(t,e,o,l,i){var n,s,a,c,r;g&&!g({column:t})||(n=t.renderVisible,s=t.halfVisible,a=formatText(t.getTitle(),1),c=t.children&&t.children.length,r=!!h&&!h({column:t}),C.push(u("tr",{key:t.id,attrs:{colid:t.id},class:["vxe-table-custom-popup--row level--".concat(t.level),{"is--group":c}],on:{dragstart:d.sortDragstartEvent,dragend:d.sortDragendEvent,dragover:d.sortDragoverEvent}},[v?u("td",{class:"vxe-table-custom-popup--column-item col--visible"},[u("div",{class:["vxe-table-custom--checkbox-option",{"is--checked":n,"is--indeterminate":s,"is--disabled":r}],attrs:{title:_conf.default.i18n("vxe.custom.setting.colVisible")},on:{click:function(){r||d.changeCheckboxOption(t)}}},[u("span",{class:["vxe-checkbox--icon",s?_conf.default.icon.TABLE_CHECKBOX_INDETERMINATE:n?_conf.default.icon.TABLE_CHECKBOX_CHECKED:_conf.default.icon.TABLE_CHECKBOX_UNCHECKED]})])]):m(),p?u("td",{class:"vxe-table-custom-popup--column-item col--sort"},[1===t.level?u("span",{class:"vxe-table-custom-popup--column-sort-btn",attrs:{title:_conf.default.i18n("vxe.custom.setting.sortHelpTip")},on:{mousedown:d.sortMousedownEvent,mouseup:d.sortMouseupEvent}},[u("i",{class:_conf.default.icon.TABLE_CUSTOM_SORT})]):u("span","-")]):m(),u("td",{class:"vxe-table-custom-popup--column-item col--name"},[u("div",{class:"vxe-table-custom-popup--name",attrs:{title:a}},a)]),b?u("td",{class:"vxe-table-custom-popup--column-item col--resizable"},[!n||t.children&&t.children.length?u("span","-"):u("vxe-input",{props:{type:"integer",value:t.renderResizeWidth},on:{modelValue:function(e){t.renderResizeWidth=Math.max(0,Number(e))}}})]):m(),x?u("td",{class:"vxe-table-custom-popup--column-item col--fixed"},[i?u("span","-"):u("vxe-radio-group",{props:{value:t.renderFixed||"",type:"button",size:"mini",options:[{label:_conf.default.i18n("vxe.custom.setting.fixedLeft"),value:"left",disabled:f},{label:_conf.default.i18n("vxe.custom.setting.fixedUnset"),value:""},{label:_conf.default.i18n("vxe.custom.setting.fixedRight"),value:"right",disabled:f}]},on:{input:function(e){t.renderFixed=e}}})]):m()])))}),t.isAll),a=t.isIndeterminate;return u("vxe-modal",{key:"modal",props:{className:["vxe-table-custom-popup-wrapper","vxe-table--ignore-clear",i.className||""].join(" "),value:t.visible,title:i.title||_conf.default.i18n("vxe.custom.cstmTitle"),width:i.width||Math.min(880,document.documentElement.clientWidth),minWidth:i.minWidth||700,height:i.height||Math.min(680,document.documentElement.clientHeight),minHeight:i.minHeight||400,showZoom:!!i.showZoom,mask:!!i.mask,lockView:!!i.lockView,resize:!!i.resize,escClosable:!!i.escClosable,destroyOnClose:!0,showFooter:!0},on:{input:function(e){t.visible=e}},scopedSlots:{default:function(){return u("div",{ref:"bodyElemRef",class:"vxe-table-custom-popup--body"},[u("div",{class:"vxe-table-custom-popup--table-wrapper"},[u("table",{},[u("colgroup",{},[v?u("col",{style:{width:"80px"}}):m(),p?u("col",{style:{width:"80px"}}):m(),u("col",{style:{minWidth:"120px"}}),b?u("col",{style:{width:"140px"}}):m(),x?u("col",{style:{width:"200px"}}):m()]),u("thead",{},[u("tr",{},[v?u("th",{},[u("div",{class:["vxe-table-custom--checkbox-option",{"is--checked":s,"is--indeterminate":a}],attrs:{title:_conf.default.i18n("vxe.table.allTitle")},on:{click:d.allCustomEvent}},[u("span",{class:["vxe-checkbox--icon",a?_conf.default.icon.TABLE_CHECKBOX_INDETERMINATE:s?_conf.default.icon.TABLE_CHECKBOX_CHECKED:_conf.default.icon.TABLE_CHECKBOX_UNCHECKED]}),u("span",{class:"vxe-checkbox--label"},_conf.default.i18n("vxe.toolbar.customAll"))])]):m(),p?u("th",{},[u("span",{class:"vxe-table-custom-popup--table-sort-help-title"},_conf.default.i18n("vxe.custom.setting.colSort")),u("vxe-tooltip",{props:{enterable:!0,content:_conf.default.i18n("vxe.custom.setting.sortHelpTip")},scopedSlots:{default:function(){return u("i",{class:"vxe-table-custom-popup--table-sort-help-icon vxe-icon-question-circle-fill"})}}})]):m(),u("th",{},_conf.default.i18n("vxe.custom.setting.colTitle")),b?u("th",{},_conf.default.i18n("vxe.custom.setting.colResizable")):m(),x?u("th",{},_conf.default.i18n("vxe.custom.setting.".concat(n?"colFixedMax":"colFixed"),[n])):m()])]),u("transition-group",{class:"vxe-table-custom--body",props:{tag:"tbody",name:"vxe-table-custom--list"}},C)])]),u("div",{ref:"dragHintElemRef",class:"vxe-table-custom-popup--drag-hint"},_conf.default.i18n("vxe.custom.cstmDragTarget",[d.dragColumn?d.dragColumn.getTitle():""]))])},footer:function(){return u("div",{class:"vxe-table-custom-popup--footer"},[u("vxe-button",{props:{content:o.resetButtonText||_conf.default.i18n("vxe.custom.cstmRestore")},on:{click:d.resetCustomEvent}}),u("vxe-button",{props:{content:o.resetButtonText||_conf.default.i18n("vxe.custom.cstmCancel")},on:{click:d.cancelCustomEvent}}),u("vxe-button",{props:{status:"primary",content:o.confirmButtonText||_conf.default.i18n("vxe.custom.cstmConfirm")},on:{click:d.confirmCustomEvent}})])}}})},_default2=exports.default={name:"VxeTableCustomPanel",props:{customStore:{type:Object,default:function(){return{}}}},inject:{$xetable:{default:null}},data:function(){return{dragColumn:null}},computed:{},render:function(e){var t=this.$xetable.customOpts;return(["modal","popup"].includes("".concat(t.mode))?renderPopupPanel:renderSimplePanel)(e,this)},methods:{handleWrapperMouseenterEvent:function(e){var t=this.$xetable;this.customStore.activeWrapper=!0,t.customOpenEvent(e)},handleWrapperMouseleaveEvent:function(e){var t=this.$xetable,o=this.customStore;o.activeWrapper=!1,setTimeout(function(){o.activeBtn||o.activeWrapper||t.customColseEvent(e)},300)},getStoreData:function(){return{}},confirmCustomEvent:function(e){var t=this.$xetable,o=t.customOpts,l=t.customColumnList,n=o.allowVisible,s=o.allowSort,a=o.allowFixed,c=o.allowResizable;_xeUtils.default.eachTree(l,function(e,t,o,l,i){i||(s&&(e.renderSortNumber=t+1),a&&(e.fixed=e.renderFixed)),c&&e.renderVisible&&(!e.children||e.children.length)&&e.renderResizeWidth!==e.renderWidth&&(e.resizeWidth=e.renderResizeWidth,e.renderWidth=e.renderResizeWidth),n&&(e.visible=e.renderVisible)}),t.closeCustom(),t.emitCustomEvent("confirm",e),t.saveCustomStore("confirm")},cancelCustomEvent:function(e){var t=this.$xetable,o=t.customStore,l=t.customOpts,i=t.customColumnList,n=o.oldSortMaps,s=o.oldFixedMaps,a=o.oldVisibleMaps,c=l.allowVisible,r=l.allowSort,u=l.allowFixed,d=l.allowResizable;_xeUtils.default.eachTree(i,function(e){var t=e.getKey(),o=!!a[t],l=s[t]||"";c&&(e.renderVisible=o,e.visible=o),u&&(e.renderFixed=l,e.fixed=l),r&&(e.renderSortNumber=n[t]||0),d&&(e.renderResizeWidth=e.renderWidth)},{children:"children"}),t.closeCustom(),t.emitCustomEvent("cancel",e)},handleResetCustomEvent:function(e){var t=this.$xetable;t.resetColumn(!0),t.closeCustom(),t.emitCustomEvent("reset",e)},resetCustomEvent:function(t){var o=this;_vXETable.default.modal?_vXETable.default.modal.confirm({content:_conf.default.i18n("vxe.custom.cstmConfirmRestore"),className:"vxe-table--ignore-clear",escClosable:!0}).then(function(e){"confirm"===e&&o.handleResetCustomEvent(t)}):this.handleResetCustomEvent(t)},resetPopupCustomEvent:function(t){var o=this;_vXETable.default.modal?_vXETable.default.modal.confirm({content:_conf.default.i18n("vxe.custom.cstmConfirmRestore"),className:"vxe-table--ignore-clear",escClosable:!0}).then(function(e){"confirm"===e&&o.resetCustomEvent(t)}):this.resetCustomEvent(t)},handleOptionCheck:function(t){var e=this.$xetable.customColumnList,e=_xeUtils.default.findTree(e,function(e){return e===t});e&&e.parent&&(e=e.parent).children&&e.children.length&&(e.visible=e.children.every(function(e){return e.visible}),e.halfVisible=!e.visible&&e.children.some(function(e){return e.visible||e.halfVisible}),this.handleOptionCheck(e))},changeCheckboxOption:function(e){var t=this.$xetable,o=t.customOpts,l=!e.renderVisible;_xeUtils.default.eachTree([e],function(e){e.renderVisible=l,e.halfVisible=!1}),this.handleOptionCheck(e),o.immediate&&(t.handleCustom(),t.saveCustomStore("update:visible")),t.checkCustomStatus()},changeFixedOption:function(e,t){var o=this.$xetable.isMaxFixedColumn;e.renderFixed===t?e.renderFixed="":o&&!e.renderFixed||(e.renderFixed=t)},allCustomEvent:function(){var e=this.$xetable,t=this.customStore,o=e.customOpts,l=e.customColumnList,i=o.checkMethod,n=!t.isAll;_xeUtils.default.eachTree(l,function(e){i&&!i({column:e})||(e.renderVisible=n,e.halfVisible=!1)}),t.isAll=n,e.checkCustomStatus()},sortMousedownEvent:function(e){var t=this.$xetable,e=e.currentTarget.parentNode.parentNode,o=e.getAttribute("colid"),t=t.getColumnById(o);e.draggable=!0,this.dragColumn=t,addClass(e,"active--drag-origin")},sortMouseupEvent:function(e){var e=e.currentTarget.parentNode.parentNode,t=this.$refs.dragHintElemRef;e.draggable=!1,this.dragColumn=null,removeClass(e,"active--drag-origin"),t&&(t.style.display="")},sortDragstartEvent:function(e){var t=new Image;e.dataTransfer&&e.dataTransfer.setDragImage(t,0,0)},sortDragendEvent:function(e){var t=this.$xetable,o=this.prevDropTrEl,l=t.customColumnList,e=e.currentTarget,i=this.$refs.dragHintElemRef;if(o){if(o!==e){var n=o.getAttribute("drag-pos"),s=e.getAttribute("colid"),a=t.getColumnById(s);if(!a)return;var s=_xeUtils.default.findIndexOf(l,function(e){return e.id===a.id}),c=o.getAttribute("colid"),r=t.getColumnById(c);if(!r)return;l.splice(s,1);t=_xeUtils.default.findIndexOf(l,function(e){return e.id===r.id});l.splice(t+("bottom"===n?1:0),0,a)}o.draggable=!1,o.removeAttribute("drag-pos"),removeClass(o,"active--drag-target")}this.dragColumn=null,e.draggable=!1,e.removeAttribute("drag-pos"),i&&(i.style.display=""),removeClass(e,"active--drag-target"),removeClass(e,"active--drag-origin")},sortDragoverEvent:function(e){var t=this.$xetable,o=this.prevDropTrEl,l=e.currentTarget,o=(o!==l&&removeClass(o,"active--drag-target"),l.getAttribute("colid")),t=t.getColumnById(o);t&&1===t.level&&(e.preventDefault(),o=e.clientY-l.getBoundingClientRect().y<l.clientHeight/2?"top":"bottom",addClass(l,"active--drag-target"),l.setAttribute("drag-pos",o),this.prevDropTrEl=l),updateDropHint(this,e)}}};