{"remainingRequest":"/Users/nieqianqian/Downloads/xinxiangmu/CRMEB/template/admin/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/nieqianqian/Downloads/xinxiangmu/CRMEB/template/admin/src/pages/system/codeGeneration/index.vue?vue&type=style&index=0&id=2f014398&lang=scss&scoped=true","dependencies":[{"path":"/Users/nieqianqian/Downloads/xinxiangmu/CRMEB/template/admin/src/pages/system/codeGeneration/index.vue","mtime":1719467759000},{"path":"/Users/nieqianqian/Downloads/xinxiangmu/CRMEB/template/admin/node_modules/css-loader/index.js","mtime":1746465018503},{"path":"/Users/nieqianqian/Downloads/xinxiangmu/CRMEB/template/admin/node_modules/vue-loader/lib/loaders/stylePostLoader.js","mtime":1746465020031},{"path":"/Users/nieqianqian/Downloads/xinxiangmu/CRMEB/template/admin/node_modules/postcss-loader/src/index.js","mtime":1746465019371},{"path":"/Users/nieqianqian/Downloads/xinxiangmu/CRMEB/template/admin/node_modules/sass-loader/dist/cjs.js","mtime":1746465018452},{"path":"/Users/nieqianqian/Downloads/xinxiangmu/CRMEB/template/admin/node_modules/cache-loader/dist/cjs.js","mtime":1746465018509},{"path":"/Users/nieqianqian/Downloads/xinxiangmu/CRMEB/template/admin/node_modules/vue-loader/lib/index.js","mtime":1746465019530}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ci5pdnUtc3RlcHMgLml2dS1zdGVwcy10aXRsZSB7CiAgbGluZS1oZWlnaHQ6IDI2cHg7Cn0KLmNvZGUtd2FwcGVyIHsKICBtaW4taGVpZ2h0OiA4MDBweDsKICBwYWRkaW5nLWJvdHRvbTogOTBweDsKfQouYnRuIHsKICBwb3NpdGlvbjogZml4ZWQ7CiAgYm90dG9tOiAxMHB4OwogIC8vIGhlaWdodDogODBweDsKICBkaXNwbGF5OiBmbGV4OwogIGp1c3RpZnktY29udGVudDogY2VudGVyOwogIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgd2lkdGg6IDEwMCU7CiAgYmFja2dyb3VuZC1jb2xvcjogcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjYpOwogIGJhY2tkcm9wLWZpbHRlcjogYmx1cig0cHgpOwogIHotaW5kZXg6IDI7Cn0KLnRhYi0xIHsKICBwYWRkaW5nLWJvdHRvbTogMTAwcHg7Cn0KOjp2LWRlZXAgLmVsLWlucHV0X19pbm5lciB7CiAgcGFkZGluZy1sZWZ0OiA3cHg7Cn0KOjp2LWRlZXAgLml2dS1mb3JtLWl0ZW0gewogIG1hcmdpbi1ib3R0b206IDE3cHg7Cn0KOjp2LWRlZXAgLml2dS1mb3JtLWl0ZW0tZXJyb3ItdGlwIHsKICBwYWRkaW5nLXRvcDogMnB4Owp9Cjo6di1kZWVwIC50aXAgewogIGNvbG9yOiAjYmJiOwogIGxpbmUtaGVpZ2h0OiAxNnB4OwogIHBhZGRpbmctdG9wOiA1cHg7CiAgZm9udC1zaXplOiAxMnB4Owp9Cgo="},{"version":3,"sources":["index.vue"],"names":[],"mappings":";AA8SA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"index.vue","sourceRoot":"src/pages/system/codeGeneration","sourcesContent":["<template>\n  <div class=\"code-wapper\">\n    <pages-header\n      ref=\"pageHeader\"\n      :title=\"$route.meta.title\"\n      :backUrl=\"$routeProStr + '/system/code_generation_list'\"\n    ></pages-header>\n    <div class=\"message mt10\">\n      <el-card :bordered=\"false\" shadow=\"never\" class=\"\">\n        <steps :stepList=\"headerList\" :isActive=\"currentTab\"></steps>\n      </el-card>\n    </div>\n    <div class=\"pt10 tab-1\" v-show=\"currentTab == '0'\" v-loading=\"isLoading\">\n      <el-card :bordered=\"false\" shadow=\"never\" class=\"ivu-mt\">\n        <FoundationForm\n          ref=\"Foundation\"\n          :foundation=\"formItem.foundation\"\n          :tableField=\"tableField\"\n          @storageData=\"storageData\"\n        />\n      </el-card>\n    </div>\n    <div class=\"pt10\" v-show=\"currentTab == '1'\">\n      <el-card :bordered=\"false\" shadow=\"never\" class=\"ivu-mt\">\n        <TableForm\n          ref=\"TableForm\"\n          :foundation=\"formItem.foundation\"\n          :tableField=\"tableField\"\n          :id=\"id\"\n          @storageData=\"storageData\"\n        />\n      </el-card>\n    </div>\n    <div class=\"pt10\" v-show=\"currentTab == '2'\">\n      <el-card :bordered=\"false\" shadow=\"never\" class=\"ivu-mt\">\n        <StorageLoc :storage=\"formItem.storage\" />\n      </el-card>\n    </div>\n    <el-card :bordered=\"false\" class=\"fixed-card\" :style=\"{ left: `${fixBottomWidth}` }\" shadow=\"never\">\n      <el-button :disabled=\"!currentTab\" class=\"mr20\" @click=\"beforeTab\">上一步</el-button>\n      <el-button type=\"primary\" @click=\"nextTab\">{{ currentTab == 2 ? '提交' : '下一步' }}</el-button>\n    </el-card>\n  </div>\n</template>\n\n<script>\nimport { codeCrud } from '@/api/setting';\nimport FoundationForm from './components/FoundationFor.vue';\nimport TableForm from './components/TableForm.vue';\nimport StorageLoc from './components/StorageLoc.vue';\nimport { getMenusUnique } from '@/api/systemMenus';\nimport { formatFlatteningRoutes } from '@/libs/system';\nimport { crudFilePath } from '@/api/systemCodeGeneration';\nimport { crudDet } from '@/api/systemCodeGeneration';\nimport { setStatus } from '@api/diy';\nimport steps from '@/components/steps/index';\n\nexport default {\n  name: 'system_code_generation',\n  components: { FoundationForm, StorageLoc, TableForm, steps },\n  data() {\n    return {\n      currentTab: 0,\n      headerList: ['基础信息', '字段配置', '存放位置'],\n      formItem: {\n        foundation: {\n          pid: '',\n          tableName: '',\n          modelName: '',\n          isTable: 1,\n          menuName: '',\n        },\n        tableForm: {},\n        storage: {},\n        field: {},\n        formItem: {},\n      },\n      ruleValidate: {\n        foundation: {},\n      },\n      tableField: [],\n      rowList: [],\n      reqloading: false,\n      isLoading: false,\n      id: '',\n    };\n  },\n  computed: {\n    // 设置是否显示 tagsView\n    fixBottomWidth() {\n      let { layout, isCollapse } = this.$store.state.themeConfig.themeConfig;\n      let w;\n      if (['columns'].includes(layout)) {\n        if (isCollapse) {\n          w = '85px';\n        } else {\n          w = '265px';\n        }\n      } else if (['classic'].includes(layout)) {\n        if (isCollapse) {\n          w = '69px';\n        } else {\n          w = '190px';\n        }\n      } else if (['defaults', 'classic'].includes(layout)) {\n        if (isCollapse) {\n          w = '64px';\n        } else {\n          w = '180px';\n        }\n      } else {\n        w = '0px';\n      }\n      return w;\n    },\n  },\n  created() {\n    if (this.$route.query.id) {\n      this.id = this.$route.query.id;\n      this.getDetail(this.$route.query.id);\n    }\n  },\n  mounted: function () {},\n  methods: {\n    getDetail(id) {\n      this.isLoading = true;\n      crudDet(id)\n        .then((res) => {\n          let data = res.data.crudInfo.field;\n          this.formItem.foundation.pid = Number(data.pid);\n          this.formItem.foundation.tableName = data.tableName;\n          this.formItem.foundation.modelName = data.modelName;\n          this.formItem.foundation.menuName = data.menuName;\n          this.$refs.TableForm.tableField = data.tableField;\n          this.formItem.storage = data.filePath;\n          let i = 0;\n          data.tableField.map((e) => {\n            if (e.field === 'create_time' || e.field === 'update_time') {\n              i++;\n              if (i == 2) this.$refs.TableForm.isCreate = true;\n            }\n            if (e.field === 'delete_time') {\n              this.$refs.TableForm.isDelete = true;\n            }\n          });\n          this.isLoading = false;\n        })\n        .catch((err) => {\n          this.$message.warning(err.msg);\n        });\n    },\n    storageData(data) {\n      this.formItem.storage = data;\n    },\n    beforeTab() {\n      this.currentTab--;\n    },\n    addRow() {\n      let foundation = this.formItem.foundation;\n      if (!foundation.tableName) return this.$message.warning('请先填写表名');\n      let data = {\n        menuName: foundation.menuName,\n        tableName: foundation.tableName,\n        // isTable: foundation.isTable,\n        fromField: [],\n        columnField: [],\n      };\n      crudFilePath(data)\n        .then((res) => {\n          this.$refs.TableForm.tableField = res.data.tableField.length ? res.data.tableField : [];\n          this.formItem.storage = res.data.makePath;\n          if (!res.data.tableField.length) {\n            this.$refs.TableForm.tableField.push({\n              field: 'id',\n              field_type: 'int',\n              default: '',\n              comment: '自增ID',\n              required: false,\n              is_table: true,\n              table_name: 'ID',\n              limit: '15',\n              primaryKey: 1,\n              from_type: '',\n            });\n          }\n          this.currentTab++;\n        })\n        .catch((err) => {\n          this.$message.warning(err.msg);\n        });\n    },\n    nextTab() {\n      if (this.currentTab == 0) {\n        // if (!this.formItem.foundation.pid) return this.$message.warning('请选择菜单');\n        if (!this.formItem.foundation.tableName) return this.$message.warning('请输入表名');\n        if (!this.formItem.foundation.modelName) return this.$message.warning('请输入模块名');\n        if (!this.formItem.foundation.isTable) {\n          if (!this.$refs.TableForm.tableField.length) return this.$message.warning('请先添加表数据');\n          if (this.$refs.TableForm.tableField.length)\n            for (let i = 0; i < this.$refs.TableForm.tableField.length; i++) {\n              const el = this.$refs.TableForm.tableField[i];\n              if (\n                ['addSoftDelete', 'addTimestamps'].indexOf(el.field_type) === -1 &&\n                (!el.field || !el.field_type || !el.comment)\n              ) {\n                return this.$message.warning('请完善sql表数据');\n              }\n            }\n        }\n        if (this.id) {\n          return this.currentTab++;\n        }\n        this.addRow();\n      } else if (this.currentTab == 2) {\n        if (this.reqloading) return;\n        let data = {\n          ...this.formItem.foundation,\n          filePath: this.formItem.storage,\n          tableField: this.$refs.TableForm.tableField,\n          deleteField: this.id ? this.$refs.TableForm.deleteField : [],\n        };\n        if (this.id) {\n          data.id = this.id;\n          this.$msgbox({\n            title: '生成提醒',\n            message: '重新提交会重新生成文件,删除、新增、修改的字段将直接从改表中进行修改,请慎重操作！！',\n            showCancelButton: true,\n            cancelButtonText: '取消',\n            confirmButtonText: '确定',\n            iconClass: 'el-icon-warning',\n            confirmButtonClass: 'btn-custom-cancel',\n          })\n            .then(() => {\n              this.saveCodeCrud(data, true);\n            })\n            .catch(() => {});\n        } else {\n          this.$msgbox({\n            title: '生成提醒',\n            message:\n              '生成后本地开发调试会直接加载生成的vue页面；如果是上线后进行生成,可以进行浏览，代码生成列表中的修改文件将不生效。需要重新打包上线！',\n            showCancelButton: true,\n            cancelButtonText: '取消',\n            confirmButtonText: '确定',\n            iconClass: 'el-icon-warning',\n            confirmButtonClass: 'btn-custom-cancel',\n          })\n            .then(() => {\n              this.saveCodeCrud(data, true);\n            })\n            .catch(() => {});\n        }\n      } else {\n        if (this.currentTab < 3) this.currentTab++;\n      }\n    },\n    saveCodeCrud(data, loading) {\n      this.reqloading = true;\n      codeCrud(data)\n        .then((res) => {\n          this.$message.success(res.msg);\n          this.getMenusUnique();\n          this.reqloading = false;\n          this.$router.push({\n            name: 'system_code_generation_list',\n          });\n        })\n        .catch((err) => {\n          this.reqloading = false;\n          this.$message.error(err.msg);\n        });\n    },\n    getMenusUnique() {\n      getMenusUnique().then((res) => {\n        let data = res.data;\n        this.$store.commit('userInfo/uniqueAuth', data.uniqueAuth);\n        this.$store.commit('menus/getmenusNav', data.menus);\n        this.$store.dispatch('routesList/setRoutesList', data.menus);\n        let arr = formatFlatteningRoutes(this.$router.options.routes);\n        this.formatTwoStageRoutes(arr);\n        let routes = formatFlatteningRoutes(data.menus);\n        this.$store.commit('menus/setOneLvRoute', routes);\n        this.bus.$emit('routesListChange');\n      });\n    },\n    formatTwoStageRoutes(arr) {\n      if (arr.length <= 0) return false;\n      const newArr = [];\n      const cacheList = [];\n      arr.forEach((v) => {\n        if (v && v.meta && v.meta.keepAlive) {\n          newArr.push({ ...v });\n          cacheList.push(v.name);\n          this.$store.dispatch('keepAliveNames/setCacheKeepAlive', cacheList);\n        }\n      });\n      return newArr;\n    },\n  },\n};\n</script>\n<style lang=\"scss\" scoped>\n.ivu-steps .ivu-steps-title {\n  line-height: 26px;\n}\n.code-wapper {\n  min-height: 800px;\n  padding-bottom: 90px;\n}\n.btn {\n  position: fixed;\n  bottom: 10px;\n  // height: 80px;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  width: 100%;\n  background-color: rgba(255, 255, 255, 0.6);\n  backdrop-filter: blur(4px);\n  z-index: 2;\n}\n.tab-1 {\n  padding-bottom: 100px;\n}\n::v-deep .el-input__inner {\n  padding-left: 7px;\n}\n::v-deep .ivu-form-item {\n  margin-bottom: 17px;\n}\n::v-deep .ivu-form-item-error-tip {\n  padding-top: 2px;\n}\n::v-deep .tip {\n  color: #bbb;\n  line-height: 16px;\n  padding-top: 5px;\n  font-size: 12px;\n}\n\n</style>\n"]}]}