{"remainingRequest":"/Users/nieqianqian/Downloads/xinxiangmu/CRMEB/template/admin/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/nieqianqian/Downloads/xinxiangmu/CRMEB/template/admin/src/pages/app/upload/index.vue?vue&type=script&lang=js","dependencies":[{"path":"/Users/nieqianqian/Downloads/xinxiangmu/CRMEB/template/admin/src/pages/app/upload/index.vue","mtime":1719467759000},{"path":"/Users/nieqianqian/Downloads/xinxiangmu/CRMEB/template/admin/node_modules/cache-loader/dist/cjs.js","mtime":1746465018509},{"path":"/Users/nieqianqian/Downloads/xinxiangmu/CRMEB/template/admin/node_modules/babel-loader/lib/index.js","mtime":1746465024347},{"path":"/Users/nieqianqian/Downloads/xinxiangmu/CRMEB/template/admin/node_modules/cache-loader/dist/cjs.js","mtime":1746465018509},{"path":"/Users/nieqianqian/Downloads/xinxiangmu/CRMEB/template/admin/node_modules/vue-loader/lib/index.js","mtime":1746465019530}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:CmltcG9ydCBTZXR0aW5nIGZyb20gJ0Avc2V0dGluZyc7CmltcG9ydCB7IHNjYW5VcGxvYWQgfSBmcm9tICdAL2FwaS9zZXR0aW5nJzsKaW1wb3J0IGNvbXByZXNzSW1nIGZyb20gJ0AvdXRpbHMvY29tcHJlc3NJbWcuanMnOwppbXBvcnQgeyBpc1BpY1VwbG9hZCB9IGZyb20gJ0AvdXRpbHMnOwoKZXhwb3J0IGRlZmF1bHQgewogIG5hbWU6ICdhcHBfdXBsb2FkX2ZpbGUnLAogIGRhdGEoKSB7CiAgICByZXR1cm4gewogICAgICBmaWxlVXJsOiBTZXR0aW5nLmFwaUJhc2VVUkwgKyAnL2ltYWdlL3NjYW5fdXBsb2FkJywKICAgICAgaW1nTGlzdDogW10sCiAgICAgIGFsbFNpemU6IDAsCiAgICAgIHRva2VuOiAnJywKICAgICAgdXBsb2FkaW5nOiB0cnVlLAogICAgICBsaW1pdDogMjAsCiAgICAgIGxvYWRpbmc6IGZhbHNlLAogICAgICBwaWQ6IDAsCiAgICB9OwogIH0sCiAgY3JlYXRlZCgpIHsKICAgIHRoaXMudG9rZW4gPSB0aGlzLiRyb3V0ZS5xdWVyeS50b2tlbjsKICAgIHRoaXMucGlkID0gdGhpcy4kcm91dGUucXVlcnkucGlkOwogICAgZG9jdW1lbnQudGl0bGUgPSAn5omL5py656uv5omr56CB5LiK5LygJzsKICB9LAogIG1ldGhvZHM6IHsKICAgIHNlbGVjdEltZ3MoKSB7CiAgICAgIGlmICh0aGlzLmxvYWRpbmcpIHJldHVybjsKICAgICAgdGhpcy4kcmVmc1sndXBsb2FkJ10uJHJlZnNbJ3VwbG9hZC1pbm5lciddLmhhbmRsZUNsaWNrKCk7CiAgICB9LAogICAgYWdhaW4oKSB7CiAgICAgIHRoaXMudXBsb2FkaW5nID0gdHJ1ZTsKICAgICAgdGhpcy5pbWdMaXN0ID0gW107CiAgICAgIHRoaXMuYWxsU2l6ZSA9IDA7CiAgICB9LAogICAgYXN5bmMgc3VibWl0VXBsb2FkKCkgewogICAgICBpZiAodGhpcy5pbWdMaXN0Lmxlbmd0aCkgewogICAgICAgIGlmICh0aGlzLmxvYWRpbmcpIHJldHVybjsKICAgICAgICB0aGlzLmxvYWRpbmcgPSB0cnVlOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5pbWdMaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBmaWxlID0gdGhpcy5pbWdMaXN0W2ldLnJhdzsKICAgICAgICAgIGF3YWl0IHRoaXMudXBsb2FkSXRlbShmaWxlKTsKICAgICAgICAgIGlmIChpID09IHRoaXMuaW1nTGlzdC5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgIHRoaXMudXBsb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMubG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLiRtZXNzYWdlLndhcm5pbmcoJ+ivt+WFiOmAieaLqeWbvueJhycpOwogICAgICB9CiAgICB9LAogICAgaGFuZGxlUmVtb3ZlKGZpbGUpIHsKICAgICAgbGV0IGluZGV4ID0gdGhpcy5pbWdMaXN0LmZpbmRJbmRleCgoZSkgPT4gewogICAgICAgIHJldHVybiBlLnVybCA9PSBmaWxlLnVybDsKICAgICAgfSk7CiAgICAgIHRoaXMuaW1nTGlzdC5zcGxpY2UoaW5kZXgsIDEpOwogICAgICB0aGlzLiRuZXh0VGljaygoZSkgPT4gewogICAgICAgIGxldCBzID0gMDsKICAgICAgICBpZiAodGhpcy5pbWdMaXN0Lmxlbmd0aCkgewogICAgICAgICAgdGhpcy5pbWdMaXN0Lm1hcCgoZSkgPT4gewogICAgICAgICAgICBzICs9IGUucmF3LnNpemU7CiAgICAgICAgICB9KTsKICAgICAgICAgIHRoaXMuYWxsU2l6ZSA9IHM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuYWxsU2l6ZSA9IDA7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCgogICAgdXBsb2FkSXRlbShmaWxlKSB7CiAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgICAgY29uc3QgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTsKICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ2ZpbGUnLCBmaWxlKTsKICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ3VwbG9hZFRva2VuJywgdGhpcy50b2tlbik7CiAgICAgICAgZm9ybURhdGEuYXBwZW5kKCdwaWQnLCB0aGlzLnBpZCk7CiAgICAgICAgc2NhblVwbG9hZChmb3JtRGF0YSkKICAgICAgICAgIC50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgaWYgKHJlcy5zdGF0dXMgPT0gMjAwKSB7CiAgICAgICAgICAgICAgcmVzb2x2ZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXMubG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgIHRoaXMuJG1lc3NhZ2UoewogICAgICAgICAgICAgICAgbWVzc2FnZTogJ+S4iuS8oOWksei0pScsCiAgICAgICAgICAgICAgICB0eXBlOiAnZXJyb3InLAogICAgICAgICAgICAgICAgZHVyYXRpb246IDEwMDAsCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pCiAgICAgICAgICAuY2F0Y2goKGVycikgPT4gewogICAgICAgICAgICB0aGlzLmxvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy4kbWVzc2FnZS5lcnJvcihlcnIubXNnKTsKICAgICAgICAgIH0pOwogICAgICB9KTsKICAgIH0sCiAgICBmaWxlRXJyb3IoZXJyLCBmaWxlLCBmaWxlTGlzdCkgewogICAgICBjb25zb2xlLmxvZyhlcnIsIGZpbGUsIGZpbGVMaXN0KTsKICAgIH0sCiAgICBiZWZvcmVVcGxvYWQoZmlsZSkgewogICAgICByZXR1cm4gaXNQaWNVcGxvYWQoZmlsZSk7CiAgICB9LAogICAgYXN5bmMgZmlsZUNoYW5nZShmaWxlLCBmaWxlTGlzdCkgewogICAgICBpZiAoZmlsZS5zaXplID49IDIwOTcxNTIpIHsKICAgICAgICBhd2FpdCB0aGlzLmNvbUltZyhmaWxlLnJhdykudGhlbigocmVzKSA9PiB7CiAgICAgICAgICBmaWxlTGlzdC5tYXAoKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudWlkID09PSBmaWxlLnVpZCkgewogICAgICAgICAgICAgIHRoaXMuYWxsU2l6ZSArPSByZXMuc2l6ZTsKICAgICAgICAgICAgICBlLnJhdyA9IHJlczsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICB0aGlzLmltZ0xpc3QgPSBmaWxlTGlzdDsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmltZ0xpc3QgPSBmaWxlTGlzdDsKICAgICAgICBsZXQgcyA9IDA7CiAgICAgICAgaWYgKHRoaXMuaW1nTGlzdC5sZW5ndGgpIHsKICAgICAgICAgIHRoaXMuaW1nTGlzdC5tYXAoKGUpID0+IHsKICAgICAgICAgICAgcyArPSBlLnJhdy5zaXplOwogICAgICAgICAgfSk7CiAgICAgICAgICB0aGlzLmFsbFNpemUgPSBzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLmFsbFNpemUgPSAwOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGNvbUltZyhmaWxlKSB7CiAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgICAgY29tcHJlc3NJbWcoZmlsZSkudGhlbigocmVzKSA9PiB7CiAgICAgICAgICByZXNvbHZlKHJlcyk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSwKICAgIGxvYWREYXRhKGl0ZW0sIGNhbGxiYWNrKSB7CiAgICAgIGdldENhdGVnb3J5TGlzdEFwaSh7CiAgICAgICAgcGlkOiBpdGVtLnZhbHVlLAogICAgICB9KQogICAgICAgIC50aGVuKGFzeW5jIChyZXMpID0+IHsKICAgICAgICAgIGNvbnN0IGRhdGEgPSByZXMuZGF0YS5saXN0OwogICAgICAgICAgY2FsbGJhY2soZGF0YSk7CiAgICAgICAgfSkKICAgICAgICAuY2F0Y2goKHJlcykgPT4ge30pOwogICAgfSwKICB9LAp9Owo="},{"version":3,"sources":["index.vue"],"names":[],"mappings":";AAkDA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"index.vue","sourceRoot":"src/pages/app/upload","sourcesContent":["<template>\n  <div class=\"main\" v-loading=\"loading\">\n    <div v-if=\"uploading\">\n      <div class=\"img-list\" :class=\"{ 'none-card': imgList.length }\">\n        <el-upload\n          ref=\"upload\"\n          :action=\"fileUrl\"\n          list-type=\"picture-card\"\n          :on-change=\"fileChange\"\n          :on-error=\"fileError\"\n          :before-upload=\"beforeUpload\"\n          :file-list=\"imgList\"\n          :auto-upload=\"false\"\n          :multiple=\"true\"\n          :limit=\"limit\"\n          accept=\"image/*\"\n        >\n          <div slot=\"default\" class=\"upload-card\" v-if=\"!imgList.length\">\n            <i class=\"el-icon-plus\"></i>\n            <p class=\"text\">点击选择图片</p>\n          </div>\n          <div slot=\"file\" slot-scope=\"{ file }\">\n            <img class=\"el-upload-list__item-thumbnail\" :src=\"file.url\" alt=\"\" />\n            <i class=\"el-icon-error btndel\" @click=\"handleRemove(file)\" />\n          </div>\n        </el-upload>\n      </div>\n\n      <div class=\"footer\">\n        <div v-if=\"imgList.length\">共{{ imgList.length }}/{{ limit }}张，{{ (allSize / 1000000).toFixed(2) }} M</div>\n        <div v-else></div>\n        <div class=\"upload-btn\">\n          <div v-if=\"imgList.length < limit\" class=\"btn\" @click=\"selectImgs\">\n            {{ imgList.length ? '继续选择' : '选择图片' }}\n          </div>\n          <div class=\"btn upload\" :class=\"{ 'no-pic': !imgList.length }\" @click=\"submitUpload\">确认上传</div>\n        </div>\n      </div>\n    </div>\n    <div v-else class=\"upload-success\">\n      <div class=\"success\">\n        <img class=\"image\" src=\"@/assets/images/success.jpg\" alt=\"\" />\n      </div>\n      <div class=\"text\">图片上传成功</div>\n      <div class=\"again\" @click=\"again\">继续上传</div>\n    </div>\n  </div>\n</template>\n\n<script>\nimport Setting from '@/setting';\nimport { scanUpload } from '@/api/setting';\nimport compressImg from '@/utils/compressImg.js';\nimport { isPicUpload } from '@/utils';\n\nexport default {\n  name: 'app_upload_file',\n  data() {\n    return {\n      fileUrl: Setting.apiBaseURL + '/image/scan_upload',\n      imgList: [],\n      allSize: 0,\n      token: '',\n      uploading: true,\n      limit: 20,\n      loading: false,\n      pid: 0,\n    };\n  },\n  created() {\n    this.token = this.$route.query.token;\n    this.pid = this.$route.query.pid;\n    document.title = '手机端扫码上传';\n  },\n  methods: {\n    selectImgs() {\n      if (this.loading) return;\n      this.$refs['upload'].$refs['upload-inner'].handleClick();\n    },\n    again() {\n      this.uploading = true;\n      this.imgList = [];\n      this.allSize = 0;\n    },\n    async submitUpload() {\n      if (this.imgList.length) {\n        if (this.loading) return;\n        this.loading = true;\n        for (let i = 0; i < this.imgList.length; i++) {\n          const file = this.imgList[i].raw;\n          await this.uploadItem(file);\n          if (i == this.imgList.length - 1) {\n            this.uploading = false;\n            this.loading = false;\n          }\n        }\n      } else {\n        this.$message.warning('请先选择图片');\n      }\n    },\n    handleRemove(file) {\n      let index = this.imgList.findIndex((e) => {\n        return e.url == file.url;\n      });\n      this.imgList.splice(index, 1);\n      this.$nextTick((e) => {\n        let s = 0;\n        if (this.imgList.length) {\n          this.imgList.map((e) => {\n            s += e.raw.size;\n          });\n          this.allSize = s;\n        } else {\n          this.allSize = 0;\n        }\n      });\n    },\n\n    uploadItem(file) {\n      return new Promise((resolve, reject) => {\n        const formData = new FormData();\n        formData.append('file', file);\n        formData.append('uploadToken', this.token);\n        formData.append('pid', this.pid);\n        scanUpload(formData)\n          .then((res) => {\n            if (res.status == 200) {\n              resolve();\n            } else {\n              this.loading = false;\n              this.$message({\n                message: '上传失败',\n                type: 'error',\n                duration: 1000,\n              });\n            }\n          })\n          .catch((err) => {\n            this.loading = false;\n            this.$message.error(err.msg);\n          });\n      });\n    },\n    fileError(err, file, fileList) {\n      console.log(err, file, fileList);\n    },\n    beforeUpload(file) {\n      return isPicUpload(file);\n    },\n    async fileChange(file, fileList) {\n      if (file.size >= 2097152) {\n        await this.comImg(file.raw).then((res) => {\n          fileList.map((e) => {\n            if (e.uid === file.uid) {\n              this.allSize += res.size;\n              e.raw = res;\n            }\n          });\n          this.imgList = fileList;\n        });\n      } else {\n        this.imgList = fileList;\n        let s = 0;\n        if (this.imgList.length) {\n          this.imgList.map((e) => {\n            s += e.raw.size;\n          });\n          this.allSize = s;\n        } else {\n          this.allSize = 0;\n        }\n      }\n    },\n    comImg(file) {\n      return new Promise((resolve, reject) => {\n        compressImg(file).then((res) => {\n          resolve(res);\n        });\n      });\n    },\n    loadData(item, callback) {\n      getCategoryListApi({\n        pid: item.value,\n      })\n        .then(async (res) => {\n          const data = res.data.list;\n          callback(data);\n        })\n        .catch((res) => {});\n    },\n  },\n};\n</script>\n<style lang=\"scss\" scoped>\n.upload-btn {\n  display: flex;\n  align-items: center;\n}\n.img-list {\n  padding: 10px;\n  overflow: scroll;\n  height: calc(100vh - 50px);\n  background-color: #fff;\n}\n\n::v-deep .el-upload-list--picture-card .el-upload-list__item {\n  // width: 113px;\n  // height: 113px;\n  // line-height: 113px;\n  // overflow: inherit;\n  margin: 1% 1% 0px 1%;\n  width: 31.3%;\n  height: 31.3%;\n  padding-top: 31.3%;\n  aspect-ratio: 1 / 1;\n}\n::v-deep .el-upload-list--picture-card .el-upload-list__item > div {\n  // position: relative;\n  width: 100%;\n  height: 100%;\n}\n::v-deep .el-upload--picture-card {\n  width: 100%;\n  height: 100%;\n  display: flex;\n  height: 146px;\n  justify-content: center;\n  align-items: center;\n  background: #f9f9f9;\n}\n::v-deep .el-upload-list--picture-card .el-upload-list__item img {\n  width: 100%;\n  height: 100%;\n  border-radius: 6px;\n  object-fit: cover;\n  position: absolute;\n  left: 0;\n  top: 0;\n}\n.btndel {\n  position: absolute;\n  z-index: 1;\n  font-size: 18px;\n  right: -1px;\n  top: -1px;\n  color: #282828;\n  opacity: 0.5;\n}\n::v-deep .el-upload--picture-card:hover,\n.el-upload:focus {\n  border-color: #c0ccda;\n}\n.img-box {\n  display: flex;\n  padding-left: 100px;\n  flex-wrap: wrap;\n}\n.none-card ::v-deep .el-upload--picture-card {\n  display: none !important;\n}\n.footer {\n  padding: 0 10px 0 15px;\n  position: fixed;\n  bottom: 0;\n  width: 100%;\n  box-sizing: border-box;\n  background-color: rgba(255, 255, 255, 0.85);\n  backdrop-filter: blur(10px);\n  z-index: 277;\n  border-top: 1px solid #f0f0f0;\n  height: 50px;\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  .btn {\n    border: 1px solid #cccccc;\n    width: 88px;\n    height: 30px;\n    border-radius: 15px;\n    color: #000;\n    font-size: 14px;\n    font-family: PingFang SC-Regular, PingFang SC;\n    font-weight: 400;\n    color: #666666;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n  }\n  .upload {\n    background-color: #e93323;\n    color: #fff;\n    margin-left: 10px;\n  }\n  .upload.no-pic {\n    background: #e93323;\n    opacity: 0.3;\n  }\n}\n.upload-card {\n  display: flex;\n  flex-direction: column;\n  line-height: 16px;\n  .el-icon-plus {\n    font-size: 28px;\n    font-weight: bold;\n    color: #bbbbbb;\n  }\n  .text {\n    font-size: 13px;\n    font-weight: 400;\n    color: #999999;\n    margin-top: 18px;\n  }\n}\n.upload-success {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  flex-direction: column;\n  height: 80vh;\n  .success {\n    width: 50px;\n    height: 50px;\n    background: #4bbc12;\n    border-radius: 50%;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    margin-bottom: 20px;\n    .image {\n      width: 60%;\n    }\n  }\n  .text {\n    font-size: 16px;\n    font-family: PingFang SC-Medium, PingFang SC;\n    font-weight: 500;\n    color: #282828;\n    margin-bottom: 40px;\n  }\n  .again {\n    width: 150px;\n    height: 43px;\n    border-radius: 21px;\n    text-align: center;\n    line-height: 41px;\n    font-size: 15px;\n    font-weight: 400;\n    color: #333333;\n    border: 1px solid #cccccc;\n  }\n}\n</style>\n"]}]}